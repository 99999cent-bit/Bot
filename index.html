<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Super Bot</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: var(--tg-theme-bg-color, #17212b);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .message-bubble { max-width: 80%; border-radius: 12px; padding: 10px; margin-bottom: 8px; font-size: 14px; }
        .user-msg { background-color: #3390ec; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-msg { background-color: #2b2b2b; color: #e4e4e4; align-self: flex-start; border-bottom-left-radius: 2px; }
        .page-enter { opacity: 0; transform: translateY(10px); animation: fadeInUp 0.3s forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Firebase SDK —á–µ—Ä–µ–∑ CDN (–¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ —Å–±–æ—Ä—â–∏–∫–∞)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- –¢–í–û–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const firebaseConfig = {
            apiKey: "AIzaSyCbzbhEn__nA9TXawnqRVU2DbZFyeJa_2U",
            authDomain: "aigenerator75-3fb8e.firebaseapp.com",
            projectId: "aigenerator75-3fb8e",
            storageBucket: "aigenerator75-3fb8e.firebasestorage.app",
            messagingSenderId: "1018038849306",
            appId: "1:1018038849306:web:462e241a3940ff591ee6a3",
            measurementId: "G-W8TPE5PLEF"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // –ü–æ–¥–∫–ª—é—á–∏–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
        const db = getFirestore(app);      // –ü–æ–¥–∫–ª—é—á–∏–ª–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è React
        window.db = db;
        window.fs = { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion };
        
        console.log("Firebase initialized for project: " + firebaseConfig.projectId);

        // –°–∏–≥–Ω–∞–ª, —á—Ç–æ Firebase –≥–æ—Ç–æ–≤
        window.firebaseReady = true;
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // !–í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏ —ç—Ç–æ —á–∏—Å–ª–æ –Ω–∞ —Å–≤–æ–π Telegram ID (—É–∑–Ω–∞–π –≤ –±–æ—Ç–µ @userinfobot), 
        // –∏–Ω–∞—á–µ —Ç—ã –Ω–µ —É–≤–∏–¥–∏—à—å –∫–Ω–æ–ø–∫—É "–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞" –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
        const ADMIN_ID = 12345678; 

        const App = () => {
            const [activeTab, setActiveTab] = useState('generate');
            const [user, setUser] = useState(null); // –î–∞–Ω–Ω—ã–µ TG —é–∑–µ—Ä–∞
            const [isLoading, setIsLoading] = useState(true);
            
            // –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            const [dbUser, setDbUser] = useState({ balance: 0, referrals: 0, refsList: [] });
            const [config, setConfig] = useState({
                priceImage: 50, priceVideo: 300, priceText: 10,
                welcomeBonus: 100, referralReward: 50, friendsForReward: 1
            });

            const [chatHistory, setChatHistory] = useState([
                { role: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! –Ø AI Bot. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' }
            ]);

            // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
            useEffect(() => {
                const initApp = async () => {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();

                    let telegramUser = tg.initDataUnsafe?.user;
                    // Mock –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ)
                    if (!telegramUser) telegramUser = { id: ADMIN_ID, first_name: 'BrowserUser', username: 'tester' };
                    
                    setUser(telegramUser);
                    
                    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Firebase —Å–∫—Ä–∏–ø—Ç–∞
                    if (!window.firebaseReady) {
                        await new Promise(resolve => document.addEventListener('firebase-ready', resolve));
                    }

                    const { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion } = window.fs;
                    const db = window.db;

                    // 1. –ü–û–î–ü–ò–°–ö–ê –ù–ê –ö–û–ù–§–ò–ì (–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
                    const configRef = doc(db, "settings", "global");
                    onSnapshot(configRef, (snap) => {
                        if (snap.exists()) {
                            setConfig(snap.data());
                        } else {
                            // –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã, –µ—Å–ª–∏ –ø—É—Å—Ç–∞—è
                            setDoc(configRef, config);
                        }
                    });

                    // 2. –†–ê–ë–û–¢–ê –° –Æ–ó–ï–†–û–ú
                    const userRef = doc(db, "users", telegramUser.id.toString());
                    const userSnap = await getDoc(userRef);

                    if (!userSnap.exists()) {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        const startParam = tg.initDataUnsafe?.start_param; // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
                        
                        await setDoc(userRef, {
                            username: telegramUser.username || '',
                            firstName: telegramUser.first_name || '',
                            balance: 100, // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å (–º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ config –ø–æ–∑–∂–µ)
                            referrals: 0,
                            refsList: [],
                            invitedBy: startParam || null,
                            createdAt: new Date()
                        });
                        
                        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞ —Ç–æ–º—É, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
                        if (startParam && startParam != telegramUser.id) {
                            const refUserRef = doc(db, "users", startParam.toString());
                            updateDoc(refUserRef, {
                                refsList: arrayUnion(telegramUser.id),
                                referrals: increment(1),
                                balance: increment(50) // –ë–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É
                            }).catch(e => console.log("Referrer not found"));
                        }
                    }

                    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    onSnapshot(userRef, (snap) => {
                        if (snap.exists()) setDbUser(snap.data());
                    });

                    setIsLoading(false);
                };

                initApp();
            }, []);

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∞
            const saveConfigToDb = async (newConfig) => {
                setConfig(newConfig); // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                const { doc, updateDoc } = window.fs;
                const configRef = doc(window.db, "settings", "global");
                await updateDoc(configRef, newConfig);
            };

            // --- –õ–û–ì–ò–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–ò ---
            const [genType, setGenType] = useState('image');
            const [prompt, setPrompt] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultMedia, setResultMedia] = useState(null);

            const handleGenerate = async () => {
                const price = genType === 'image' ? config.priceImage : config.priceVideo;
                
                if (dbUser.balance < price) {
                    return window.Telegram.WebApp.showAlert(`–ù—É–∂–Ω–æ ${price} —Ç–æ–∫–µ–Ω–æ–≤. –£ –≤–∞—Å ${dbUser.balance}.`);
                }
                if (!prompt) return;

                // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –≤ –ë–î
                const { doc, updateDoc, increment } = window.fs;
                const userRef = doc(window.db, "users", user.id.toString());
                await updateDoc(userRef, { balance: increment(-price) });

                setIsProcessing(true);
                setResultMedia(null);

                // –ò–º–∏—Ç–∞—Ü–∏—è API (–ó–¥–µ—Å—å –ø–æ—Ç–æ–º –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –Ω–µ–π—Ä–æ–Ω–∫–µ)
                setTimeout(() => {
                    setIsProcessing(false);
                    if (genType === 'image') setResultMedia(`https://placehold.co/600x600/1a1a1a/FFF.png?text=${encodeURIComponent(prompt)}`);
                    else setResultMedia("https://media.giphy.com/media/l41lI4bYmcsPJX9Nk/giphy.gif");
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }, 2000);
            };

            // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ---
            const [chatInput, setChatInput] = useState('');
            const chatEndRef = useRef(null);

            const handleSendChat = async () => {
                if (dbUser.balance < config.priceText) return window.Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤!");
                if (!chatInput.trim()) return;

                // –°–ø–∏—Å—ã–≤–∞–µ–º
                const { doc, updateDoc, increment } = window.fs;
                const userRef = doc(window.db, "users", user.id.toString());
                await updateDoc(userRef, { balance: increment(-config.priceText) });

                setChatHistory(prev => [...prev, { role: 'user', text: chatInput }]);
                const currentInput = chatInput;
                setChatInput('');
                
                setTimeout(() => {
                    setChatHistory(prev => [...prev, { role: 'ai', text: `AI: –Ø –ø–æ–ª—É—á–∏–ª –∑–∞–ø—Ä–æ—Å "${currentInput}". –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.` }]);
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }, 1000);
            };
            
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

            // --- –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI ---

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-[#17212b]">
                        <div className="text-blue-500 text-xl font-bold">
                            <i className="fas fa-circle-notch fa-spin mr-2"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                );
            }

            const TabGenerate = () => (
                <div className="page-enter p-4 pb-24">
                    <div className="flex justify-between items-center mb-4 px-2">
                        <span className="text-gray-400 text-sm">–ë–∞–ª–∞–Ω—Å: <b className="text-yellow-400">{dbUser.balance}</b></span>
                    </div>
                    <div className="flex bg-gray-800 rounded-lg p-1 mb-6">
                        <button onClick={() => setGenType('image')} className={`flex-1 py-2 rounded text-sm font-bold ${genType === 'image' ? 'bg-blue-600' : 'text-gray-400'}`}>–ö–∞—Ä—Ç–∏–Ω–∫–∞ ({config.priceImage}—Ç)</button>
                        <button onClick={() => setGenType('video')} className={`flex-1 py-2 rounded text-sm font-bold ${genType === 'video' ? 'bg-purple-600' : 'text-gray-400'}`}>–í–∏–¥–µ–æ ({config.priceVideo}—Ç)</button>
                    </div>
                    <textarea 
                        value={prompt} onChange={e => setPrompt(e.target.value)}
                        placeholder="–û–ø–∏—à–∏, —á—Ç–æ —Å–æ–∑–¥–∞—Ç—å..."
                        className="w-full bg-gray-800 rounded-xl p-4 mb-4 text-white min-h-[120px] border border-gray-700 focus:border-blue-500 outline-none"
                    ></textarea>
                    <button onClick={handleGenerate} disabled={isProcessing} className="w-full bg-gradient-to-r from-blue-600 to-blue-500 py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                        {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : <span>üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>}
                    </button>
                    {resultMedia && <img src={resultMedia} className="mt-6 w-full rounded-xl border border-gray-700" alt="Res" />}
                </div>
            );

            const TabChat = () => (
                <div className="page-enter flex flex-col h-[calc(100vh-80px)]">
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {chatHistory.map((msg, idx) => (
                            <div key={idx} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`message-bubble ${msg.role === 'user' ? 'user-msg' : 'ai-msg'}`}>{msg.text}</div>
                            </div>
                        ))}
                        <div ref={chatEndRef} />
                    </div>
                    <div className="p-3 bg-gray-900 border-t border-gray-800 flex items-center gap-2">
                        <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder={`–°–ø—Ä–æ—Å–∏ (${config.priceText}—Ç)...`} className="flex-1 bg-gray-800 text-white rounded-full px-4 py-2 outline-none border border-gray-700"/>
                        <button onClick={handleSendChat} className="w-10 h-10 rounded-full bg-blue-600 text-white"><i className="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            );

            const TabProfile = () => {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É. –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–∞–º–µ–Ω–∏ "YourBotName" –Ω–∞ —é–∑–µ—Ä–Ω–µ–π–º —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞
                const inviteLink = `https://t.me/YourBotName?start=${user.id}`;
                
                const copyLink = () => {
                    navigator.clipboard.writeText(inviteLink);
                    window.Telegram.WebApp.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                };

                return (
                    <div className="page-enter p-4 pb-24">
                        <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 mb-6 border border-gray-700">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h2 className="text-xl font-bold">{user.first_name}</h2>
                                    <p className="text-gray-400 text-sm">ID: {user.id}</p>
                                </div>
                                <div className="text-right">
                                    <span className="block text-3xl font-bold text-yellow-500">{dbUser.balance}</span>
                                    <span className="text-xs text-gray-400">TOKENS</span>
                                </div>
                            </div>
                            
                            {/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç */}
                            {user.id === ADMIN_ID && (
                                <button onClick={() => setActiveTab('admin')} className="w-full bg-red-900/50 text-red-200 py-2 rounded-lg text-sm mb-4 border border-red-800">
                                    <i className="fas fa-cogs mr-2"></i> –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞
                                </button>
                            )}
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-gray-800/50 p-3 rounded-xl text-center">
                                    <i className="fas fa-users text-green-400 mb-1"></i>
                                    <p className="text-xs text-gray-400">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</p>
                                    <p className="font-bold">{dbUser.referrals}</p>
                                </div>
                                <div className="bg-gray-800/50 p-3 rounded-xl text-center">
                                    <i className="fas fa-clock text-blue-400 mb-1"></i>
                                    <p className="text-xs text-gray-400">–°—Ç–∞—Ç—É—Å</p>
                                    <p className="font-bold text-xs pt-1">PRO</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-gray-800 rounded-2xl p-6 border border-gray-700">
                            <h3 className="font-bold mb-2 flex items-center"><i className="fas fa-gift text-pink-500 mr-2"></i> –†–µ—Ñ–µ—Ä–∞–ª–∫–∞</h3>
                            <p className="text-sm text-gray-400 mb-4">–ù–∞–≥—Ä–∞–¥–∞: <b>{config.referralReward} —Ç–æ–∫–µ–Ω–æ–≤</b> –∑–∞ –¥—Ä—É–≥–∞.</p>
                            <div className="bg-black/30 p-3 rounded-lg flex items-center justify-between mb-4">
                                <code className="text-xs text-blue-300 truncate max-w-[200px]">{inviteLink}</code>
                                <button onClick={copyLink} className="text-white bg-blue-600 px-3 py-1 rounded text-xs font-bold">–ö–æ–ø–∏—è</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const TabAdmin = () => (
                <div className="page-enter p-4 pb-24">
                    <div className="flex items-center mb-6">
                        <button onClick={() => setActiveTab('profile')} className="mr-4 text-gray-400"><i className="fas fa-arrow-left"></i></button>
                        <h2 className="text-xl font-bold text-red-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Cloud</h2>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 space-y-4">
                        <div>
                            <label className="text-xs text-gray-500">–¶–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏</label>
                            <input type="number" value={config.priceImage} onChange={e => saveConfigToDb({...config, priceImage: Number(e.target.value)})} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                        </div>
                        <div>
                            <label className="text-xs text-gray-500">–¶–µ–Ω–∞ –≤–∏–¥–µ–æ</label>
                            <input type="number" value={config.priceVideo} onChange={e => saveConfigToDb({...config, priceVideo: Number(e.target.value)})} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                        </div>
                        <div className="bg-green-900/30 p-3 rounded text-xs text-green-200">
                            <i className="fas fa-cloud mr-1"></i> –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
                        </div>
                    </div>
                </div>
            );

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center space-y-1 w-16 transition-all ${activeTab === id ? 'text-blue-500 scale-110' : 'text-gray-500'}`}>
                    <i className={`fas ${icon} text-xl`}></i>
                    <span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen bg-[#17212b]">
                    {activeTab === 'generate' && <TabGenerate />}
                    {activeTab === 'chat' && <TabChat />}
                    {activeTab === 'profile' && <TabProfile />}
                    {activeTab === 'admin' && <TabAdmin />}
                    <div className="fixed bottom-0 left-0 right-0 bg-[#1c2936] border-t border-gray-800 pb-safe pt-2 px-6 flex justify-around z-40 h-[70px]">
                        <NavItem id="generate" icon="fa-wand-magic-sparkles" label="–ò–º–∏–¥–∂" />
                        <NavItem id="chat" icon="fa-comments" label="–ß–∞—Ç" />
                        <NavItem id="profile" icon="fa-user-astronaut" label="–ü—Ä–æ—Ñ–∏–ª—å" />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
