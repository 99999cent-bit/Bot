<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Bot Pro</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: var(--tg-theme-bg-color, #17212b);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            min-height: 100vh; 
            margin: 0;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .message-bubble { max-width: 85%; border-radius: 16px; padding: 12px; margin-bottom: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user-msg { background-color: #3390ec; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-msg { background-color: #2b2b2b; color: #e4e4e4; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .page-enter { opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .slide-down { animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1c2936; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #3390ec; position: relative; }
        
        .fullscreen-media { max-width: 100%; max-height: 90vh; object-fit: contain; }
        .close-fs-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 101; cursor: pointer; }

        .tariff-card { background: linear-gradient(145deg, #2b3c4e, #1c2936); border: 1px solid #334e68; transition: transform 0.1s; position: relative; overflow: hidden; }
        .tariff-card:active { transform: scale(0.98); }

        .media-card { background: #1c2936; border-radius: 16px; overflow: hidden; margin-top: 16px; border: 1px solid #2b3c4e; position: relative; }
        .media-actions { display: flex; border-top: 1px solid #2b3c4e; }
        .media-btn { flex: 1; padding: 12px; text-align: center; color: #3390ec; font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.02); }
        .media-btn:active { background: rgba(255,255,255,0.05); }

        .chat-input-area { position: fixed; bottom: 0; left: 0; right: 0; background: #17212b; padding: 10px; border-top: 1px solid #2b2b2b; z-index: 40; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        
        .chat-item { background: #233040; border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .chat-item:active { transform: scale(0.98); background: #2b3c4e; }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: #ff4d4d; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: transform 0.2s; }
        .delete-btn:active { transform: scale(0.9); background: rgba(255,0,0,0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, collection, getDocs, query, where, addDoc, serverTimestamp, deleteDoc, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbzbhEn__nA9TXawnqRVU2DbZFyeJa_2U",
            authDomain: "aigenerator75-3fb8e.firebaseapp.com",
            projectId: "aigenerator75-3fb8e",
            storageBucket: "aigenerator75-3fb8e.firebasestorage.app",
            messagingSenderId: "1018038849306",
            appId: "1:1018038849306:web:462e241a3940ff591ee6a3",
            measurementId: "G-W8TPE5PLEF"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        window.db = db;
        window.fs = { 
            doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, 
            collection, getDocs, query, where, addDoc, serverTimestamp, deleteDoc, writeBatch 
        };
        window.firebaseReady = true;
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        const ADMIN_ID = 442529744; 

        const copyToClipboard = async (text) => {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                return true;
            } catch (err) {
                console.error('Copy failed', err);
                return false;
            }
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('generate');
            const [genType, setGenType] = useState('image'); 
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [globalHistory, setGlobalHistory] = useState([]);
            const [payModalData, setPayModalData] = useState(null);
            const [shareModalItem, setShareModalItem] = useState(null);
            const [fullscreenItem, setFullscreenItem] = useState(null); 
            const [dbUser, setDbUser] = useState({ balance: 0, referrals: 0, firstName: '', spent: 0 });
            
            const [config, setConfig] = useState({
                priceImage: 50, priceVideo: 300, priceText: 10,
                welcomeBonus: 100, referralReward: 50,
                tokenPriceRub: 1.0, 
                paymentLink: "", 
                qrUrl: "https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg",
                botToken: "",
                tariffs: [
                    { id: 1, name: 'üöÄ –°—Ç–∞—Ä—Ç', tokens: 100, price: 99 },
                    { id: 2, name: 'üíé –ü—Ä–æ—Ñ–∏', tokens: 500, price: 450 },
                    { id: 3, name: 'üëë –û–ª–∏–≥–∞—Ä—Ö', tokens: 1000, price: 800 }
                ]
            });

            useEffect(() => {
                const initApp = async () => {
                    try {
                        const tg = window.Telegram.WebApp;
                        tg.ready();
                        tg.expand();
                        tg.enableClosingConfirmation();

                        let telegramUser = tg.initDataUnsafe?.user;
                        if (!telegramUser) telegramUser = { id: ADMIN_ID, first_name: 'Admin', username: 'admin' };
                        
                        if (!window.firebaseReady) await new Promise(r => document.addEventListener('firebase-ready', r));

                        const { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, collection } = window.fs;
                        const db = window.db;

                        const configRef = doc(db, "settings", "global");
                        onSnapshot(configRef, (snap) => {
                            if (snap.exists()) setConfig(prev => ({ ...prev, ...snap.data() }));
                            else setDoc(configRef, config);
                        });

                        const userRef = doc(db, "users", telegramUser.id.toString());
                        const userSnap = await getDoc(userRef);

                        if (!userSnap.exists()) {
                            const urlParams = new URLSearchParams(window.location.search);
                            const startParam = tg.initDataUnsafe?.start_param || urlParams.get('start'); 
                            
                            await setDoc(userRef, {
                                username: telegramUser.username || '',
                                firstName: telegramUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                                balance: config.welcomeBonus || 100,
                                referrals: 0,
                                spent: 0,
                                invitedBy: startParam || null,
                                createdAt: new Date().toISOString()
                            });

                            if (startParam && startParam != telegramUser.id) {
                                const refUserRef = doc(db, "users", startParam.toString());
                                const refSnap = await getDoc(refUserRef);
                                if(refSnap.exists()){
                                    updateDoc(refUserRef, {
                                        referrals: increment(1),
                                        balance: increment(config.referralReward || 50) 
                                    }).catch(console.error);
                                }
                            }
                        }
                        
                        setUser({ ...telegramUser, first_name: telegramUser.first_name || 'User' });
                        
                        onSnapshot(userRef, (snap) => {
                            if (snap.exists()) setDbUser(snap.data());
                        });

                        const historyRef = collection(db, "users", telegramUser.id.toString(), "history");
                        onSnapshot(historyRef, (snapshot) => {
                            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            list.sort((a,b) => {
                                const ta = a.createdAt?.seconds || 0;
                                const tb = b.createdAt?.seconds || 0;
                                return tb - ta;
                            });
                            setGlobalHistory(list);
                        });

                    } catch (e) {
                        console.error("Init Error:", e);
                        window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + e.message);
                    } finally {
                        setIsLoading(false);
                    }
                };
                initApp();
            }, []);

            const saveConfigToDb = async (newConfig) => {
                try {
                    const { updateDoc, doc } = window.fs;
                    await updateDoc(doc(window.db, "settings", "global"), newConfig);
                    window.Telegram.WebApp.showAlert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                } catch(e) { window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!"); }
            };

            const handleSpend = async (amount) => {
                if (user.id === ADMIN_ID) return true;
                if (dbUser.balance < amount) {
                    window.Telegram.WebApp.showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤! –ù—É–∂–Ω–æ ${amount}`);
                    return false;
                }
                await window.fs.updateDoc(window.fs.doc(window.db, "users", user.id.toString()), { 
                    balance: window.fs.increment(-amount),
                    spent: window.fs.increment(1)
                });
                return true; 
            };

            // –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò (IMAGE HACK)
            // –û–±—Ö–æ–¥–∏—Ç CORS, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ —Å –ª—é–±–æ–≥–æ –¥–æ–º–µ–Ω–∞
            const sendMediaToTelegram = (type, url, prompt) => {
                if (!config.botToken) {
                    window.Telegram.WebApp.showAlert("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∞–¥–º–∏–Ω–∫–µ!");
                    return;
                }
                
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('selection');
                
                const method = type === 'image' ? 'sendPhoto' : 'sendVideo';
                const param = type === 'image' ? 'photo' : 'video';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–∞
                const apiUrl = `https://api.telegram.org/bot${config.botToken}/${method}?chat_id=${user.id}&${param}=${encodeURIComponent(url)}&caption=${encodeURIComponent("üé® " + prompt)}`;
                
                // –°–æ–∑–¥–∞–µ–º "–Ω–µ–≤–∏–¥–∏–º—É—é" –∫–∞—Ä—Ç–∏–Ω–∫—É. –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –µ—ë –∑–∞–≥—Ä—É–∑–∏—Ç—å, —Ç–µ–º —Å–∞–º—ã–º –≤—ã–ø–æ–ª–Ω–∏–≤ GET –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä Telegram.
                // Telegram –≤—ã–ø–æ–ª–Ω–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ (–æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ), –¥–∞–∂–µ –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ—Ç–æ–º —Å–∫–∞–∂–µ—Ç, —á—Ç–æ —ç—Ç–æ "–ø–ª–æ—Ö–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞".
                new Image().src = apiUrl;
                
                window.Telegram.WebApp.showAlert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ï—Å–ª–∏ –±–æ—Ç –º–æ–ª—á–∏—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –Ω–∞–∂–∞–ª–∏ /start –≤ —á–∞—Ç–µ —Å –Ω–∏–º.");
            };

            const deleteMedia = async (e, id) => {
                e.stopPropagation();
                if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
                try {
                    const { deleteDoc, doc } = window.fs;
                    await deleteDoc(doc(window.db, "users", user.id.toString(), "history", id));
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                } catch (err) {
                    window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
                }
            };

            const clearAllHistory = async () => {
                const typeName = genType === 'image' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' : '–≤–∏–¥–µ–æ';
                if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å—è –∏—Å—Ç–æ—Ä–∏—è ${typeName} –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.`)) return;
                
                try {
                    const { deleteDoc, doc } = window.fs;
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –º–µ–¥–∏–∞
                    const itemsToDelete = globalHistory.filter(item => item.type === genType);
                    
                    if (itemsToDelete.length === 0) {
                        window.Telegram.WebApp.showAlert("–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å.");
                        return;
                    }

                    // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
                    const promises = itemsToDelete.map(item => 
                        deleteDoc(doc(window.db, "users", user.id.toString(), "history", item.id))
                    );
                    
                    await Promise.all(promises);
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.Telegram.WebApp.showAlert(`–ò—Å—Ç–æ—Ä–∏—è ${typeName} –æ—á–∏—â–µ–Ω–∞!`);
                } catch (err) {
                    console.error(err);
                    window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏");
                }
            };

            const TabGenerate = () => {
                const [prompt, setPrompt] = useState('');
                const [isProc, setIsProc] = useState(false);

                const go = async () => {
                    if (!prompt) return;
                    const price = genType === 'image' ? config.priceImage : config.priceVideo;
                    if (!(await handleSpend(price))) return;

                    setIsProc(true);
                    setTimeout(async () => {
                        const { addDoc, collection, serverTimestamp } = window.fs;
                        const newUrl = genType === 'image' 
                            ? `https://placehold.co/600x600/1a1a1a/FFF.png?text=${encodeURIComponent(prompt)}` 
                            : "https://www.w3schools.com/html/mov_bbb.mp4";
                        
                        await addDoc(collection(window.db, "users", user.id.toString(), "history"), {
                            type: genType, url: newUrl, prompt: prompt,
                            date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            createdAt: serverTimestamp() 
                        });
                        
                        setIsProc(false);
                        setPrompt('');
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    }, 2000);
                };

                const list = globalHistory.filter(item => item.type === genType);

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="flex justify-between mb-4">
                            <span className="text-gray-400">–ë–∞–ª–∞–Ω—Å: <b className="text-yellow-400">{user.id === ADMIN_ID ? '‚àû (Admin)' : dbUser.balance}</b></span>
                        </div>
                        <div className="flex bg-gray-800 rounded-lg p-1 mb-4">
                            <button onClick={() => setGenType('image')} className={`flex-1 py-2 rounded font-bold text-sm ${genType === 'image' ? 'bg-blue-600' : 'text-gray-500'}`}>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ({config.priceImage})</button>
                            <button onClick={() => setGenType('video')} className={`flex-1 py-2 rounded font-bold text-sm ${genType === 'video' ? 'bg-purple-600' : 'text-gray-500'}`}>–í–∏–¥–µ–æ ({config.priceVideo})</button>
                        </div>
                        <textarea value={prompt} onChange={e => setPrompt(e.target.value)} placeholder={`–û–ø–∏—à–∏ ${genType === 'image' ? '–∫–∞—Ä—Ç–∏–Ω–∫—É' : '–≤–∏–¥–µ–æ'}...`} className="w-full bg-gray-800 rounded-xl p-4 mb-4 text-white min-h-[100px] border border-gray-700 outline-none"></textarea>
                        <button onClick={go} disabled={isProc} className={`w-full py-3 rounded-xl font-bold ${genType === 'image' ? 'bg-blue-600' : 'bg-purple-600'}`}>
                            {isProc ? <i className="fas fa-spinner fa-spin"></i> : "üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"}
                        </button>
                        <div className="mt-6 space-y-4">
                            <div className="flex justify-between items-center pl-1 mb-2">
                                <h3 className="text-gray-400 text-sm font-bold">–ò—Å—Ç–æ—Ä–∏—è {genType === 'image' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' : '–≤–∏–¥–µ–æ'}:</h3>
                                {list.length > 0 && (
                                    <button onClick={clearAllHistory} className="text-red-400 text-xs font-bold border border-red-900 bg-red-900/20 px-3 py-1 rounded hover:bg-red-900/40 transition">
                                        <i className="fas fa-trash-alt mr-1"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                                    </button>
                                )}
                            </div>
                            
                            {list.length === 0 && (
                                <div className="text-center text-gray-500 text-sm py-4 bg-gray-800/50 rounded-xl">
                                    –ü—É—Å—Ç–æ. –°–æ–∑–¥–∞–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!
                                </div>
                            )}
                            
                            {list.map(item => (
                                <div key={item.id} className="media-card slide-down">
                                    <div className="delete-btn" onClick={(e) => deleteMedia(e, item.id)}>
                                        <i className="fas fa-times"></i>
                                    </div>
                                    <div className="p-3 bg-[#233040] border-b border-[#2b3c4e] flex justify-between items-center pr-10">
                                        <span className="text-xs text-gray-400 truncate max-w-[90%]">{item.prompt}</span>
                                        <span className="text-[10px] text-gray-500">{item.date}</span>
                                    </div>
                                    <div className="bg-black flex justify-center items-center min-h-[200px]" onClick={() => setFullscreenItem(item)}>
                                        {item.type === 'image' ? (
                                            <img src={item.url} className="max-w-full max-h-[400px] object-contain" alt="Gen" />
                                        ) : (
                                            <video src={item.url} controls className="max-w-full max-h-[400px]" />
                                        )}
                                    </div>
                                    <div className="media-actions">
                                        <button onClick={() => sendMediaToTelegram(item.type, item.url, item.prompt)} className="media-btn border-r border-[#2b3c4e]">
                                            <i className="fas fa-paper-plane mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–µ
                                        </button>
                                        <button onClick={() => setShareModalItem(item)} className="media-btn">
                                            <i className="fas fa-share-nodes mr-2"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const TabChat = () => {
                const [chatId, setChatId] = useState(null);
                const [list, setList] = useState([]);
                const [msgs, setMsgs] = useState([]);
                const [txt, setTxt] = useState('');
                const [loadL, setLoadL] = useState(true);
                const endRef = useRef(null);

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
                useEffect(() => {
                    if (!user) return;
                    const { collection, onSnapshot } = window.fs;
                    return onSnapshot(collection(window.db, "users", user.id.toString(), "chats"), (snap) => {
                        const d = snap.docs.map(x => ({id: x.id, ...x.data()}));
                        d.sort((a,b) => (b.updatedAt?.seconds||0) - (a.updatedAt?.seconds||0));
                        setList(d);
                        setLoadL(false);
                    });
                }, [user]);

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
                useEffect(() => {
                    if (!chatId || !user) { setMsgs([]); return; }
                    const { collection, onSnapshot } = window.fs;
                    return onSnapshot(collection(window.db, "users", user.id.toString(), "chats", chatId, "messages"), (snap) => {
                        const d = snap.docs.map(x => ({id: x.id, ...x.data()}));
                        d.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
                        setMsgs(d);
                        setTimeout(() => endRef.current?.scrollIntoView({behavior:"smooth"}), 100);
                    });
                }, [chatId, user]);

                const createChat = async () => {
                    const { addDoc, collection, serverTimestamp } = window.fs;
                    const ref = await addDoc(collection(window.db, "users", user.id.toString(), "chats"), {
                        title: "–ù–æ–≤—ã–π —á–∞—Ç", createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                    });
                    setChatId(ref.id);
                };

                const deleteChat = async (e, id) => {
                    e.stopPropagation();
                    if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
                    await window.fs.deleteDoc(window.fs.doc(window.db, "users", user.id.toString(), "chats", id));
                    if(chatId === id) setChatId(null);
                };

                const send = async () => {
                    if (!txt.trim()) return;
                    if (!(await handleSpend(config.priceText))) return;
                    
                    const { addDoc, collection, serverTimestamp, updateDoc, doc } = window.fs;
                    const text = txt; setTxt('');
                    
                    let cid = chatId;
                    if (!cid) {
                        const ref = await addDoc(collection(window.db, "users", user.id.toString(), "chats"), {
                            title: text.slice(0,20)+"...", createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                        });
                        cid = ref.id; setChatId(cid);
                    } else {
                        updateDoc(doc(window.db, "users", user.id.toString(), "chats", cid), { updatedAt: serverTimestamp() });
                    }

                    await addDoc(collection(window.db, "users", user.id.toString(), "chats", cid, "messages"), {
                        role: 'user', text: text, createdAt: serverTimestamp()
                    });

                    setTimeout(() => {
                        addDoc(collection(window.db, "users", user.id.toString(), "chats", cid, "messages"), {
                            role: 'ai', text: "–û—Ç–≤–µ—Ç –Ω–∞: " + text, createdAt: serverTimestamp()
                        });
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    }, 1000);
                };

                if (!chatId) {
                    return (
                        <div className="page-enter p-4 pb-24">
                            <button onClick={createChat} className="w-full py-4 rounded-xl bg-blue-600 font-bold text-white shadow-lg mb-6 flex items-center justify-center gap-2"><i className="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç</button>
                            <h3 className="text-gray-400 text-sm font-bold mb-3 pl-1">–î–∏–∞–ª–æ–≥–∏:</h3>
                            {loadL && <div className="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>}
                            {!loadL && list.length === 0 && <div className="text-center text-gray-500 mt-4">–ü—É—Å—Ç–æ</div>}
                            <div className="space-y-2">
                                {list.map(c => (
                                    <div key={c.id} onClick={() => setChatId(c.id)} className="chat-item flex justify-between items-center">
                                        <div className="truncate text-white text-sm font-medium pl-2">{c.title}</div>
                                        <button onClick={(e) => deleteChat(e, c.id)} className="p-2 text-gray-500"><i className="fas fa-trash"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="page-enter flex flex-col h-screen fixed inset-0 z-50 bg-[#17212b]">
                        <div className="h-[60px] bg-[#1c2936] flex items-center px-4 border-b border-gray-800 shrink-0">
                            <button onClick={() => setChatId(null)} className="text-blue-500 font-medium flex gap-2"><i className="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥</button>
                            <span className="ml-4 font-bold truncate text-white">{list.find(c => c.id === chatId)?.title || '–ß–∞—Ç'}</span>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-[#17212b]">
                            {msgs.map(m => (
                                <div key={m.id} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`message-bubble ${m.role === 'user' ? 'user-msg' : 'ai-msg'}`}>{m.text}</div>
                                </div>
                            ))}
                            <div ref={endRef} />
                        </div>
                        <div className="chat-input-area flex items-center gap-2">
                            <input value={txt} onChange={e => setTxt(e.target.value)} placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." className="flex-1 bg-gray-800 text-white rounded-full px-4 py-3 outline-none border border-gray-600"/>
                            <button onClick={send} className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg"><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                );
            };

            const TabProfile = () => {
                const [buyV, setBuyV] = useState(100);
                const link = `https://t.me/Ai_Generator75_Bot?start=${user?.id}`;

                const handleBuy = (amt, price, name) => {
                    setPayModalData({ name: name || '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ', tokens: amt, price: price || Math.ceil(amt * config.tokenPriceRub) });
                };

                const copyLink = async () => {
                    if (await copyToClipboard(link)) window.Telegram.WebApp.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
                    else window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
                };

                if (!user) return <div className="p-10 text-center text-white">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>;

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="bg-gray-800 rounded-2xl p-6 mb-4 border border-gray-700">
                            <div className="flex justify-between items-start mb-4">
                                <div><h2 className="text-2xl font-bold text-white">{user.first_name}</h2><p className="text-gray-400 text-sm">ID: {user.id}</p></div>
                                <div className="text-right"><span className="block text-4xl font-bold text-yellow-400">{user.id===ADMIN_ID ? '‚àû' : dbUser.balance}</span><span className="text-xs text-gray-400 uppercase">–¢–æ–∫–µ–Ω–æ–≤</span></div>
                            </div>
                            {user.id === ADMIN_ID && <button onClick={() => setActiveTab('admin')} className="w-full bg-gray-700 py-2 rounded-xl text-sm border border-gray-600 text-white">–ê–¥–º–∏–Ω–∫–∞</button>}
                        </div>

                        <div className="bg-gray-800 rounded-2xl p-5 border border-gray-700 mb-4">
                            <h3 className="font-bold text-lg mb-2 text-white">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</h3>
                            <p className="text-sm text-gray-300 mb-2">–ù–∞–≥—Ä–∞–¥–∞: {config.referralReward} —Ç.</p>
                            <div className="flex gap-2">
                                <div className="bg-black/40 p-3 rounded-lg flex-1 overflow-hidden"><p className="text-xs text-gray-400 truncate">{link}</p></div>
                                <button onClick={copyLink} className="bg-blue-600 px-4 rounded-lg font-bold text-sm text-white">–ö–æ–ø–∏—è</button>
                            </div>
                        </div>

                        <h3 className="text-lg font-bold mb-3 pl-1 text-white">üì¶ –ü–∞–∫–µ—Ç—ã</h3>
                        <div className="grid gap-3 mb-6">
                            {(config.tariffs || []).map(t => (
                                <div key={t.id} onClick={() => handleBuy(t.tokens, t.price, t.name)} className="tariff-card rounded-xl p-4 flex justify-between items-center cursor-pointer">
                                    <div className="flex items-center">
                                        <div className="bg-blue-600/20 text-blue-400 w-10 h-10 rounded-full flex items-center justify-center mr-3"><i className="fas fa-bolt"></i></div>
                                        <div><div className="font-bold text-base text-white">{t.name}</div><div className="text-gray-400 text-xs">{t.tokens} —Ç.</div></div>
                                    </div>
                                    <div className="bg-blue-600 px-3 py-1.5 rounded-lg font-bold text-sm text-white">{t.price} ‚ÇΩ</div>
                                </div>
                            ))}
                        </div>

                         <div className="bg-gray-800 rounded-2xl p-5 border border-gray-700 mb-4">
                            <h3 className="font-bold text-lg mb-3 text-white"><i className="fas fa-calculator text-gray-400 mr-2"></i>–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
                            <div className="mb-4">
                                <label className="text-xs text-gray-400 mb-1 block">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∏–Ω–∏–º—É–º 100):</label>
                                <div className="flex items-center bg-gray-900 rounded-xl border border-gray-600 overflow-hidden">
                                    <input 
                                        type="number" 
                                        value={buyV}
                                        onChange={e => setBuyV(e.target.value === '' ? '' : Number(e.target.value))}
                                        className="flex-1 bg-transparent p-3 text-white outline-none font-mono"
                                    />
                                    <span className="pr-4 text-gray-500 text-sm">—à—Ç.</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">–ö—É—Ä—Å: 1 —Ç–æ–∫–µ–Ω = {config.tokenPriceRub} ‚ÇΩ</p>
                            </div>
                            <button onClick={() => handleBuy(buyV, Math.ceil(buyV * config.tokenPriceRub), '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞')} className="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex justify-center items-center text-white">
                                <span>–ö—É–ø–∏—Ç—å –∑–∞ {Math.ceil(buyV * config.tokenPriceRub)} ‚ÇΩ</span>
                            </button>
                        </div>
                    </div>
                );
            };

            const TabAdmin = () => {
                const [tab, setTab] = useState('set'); 
                const [lc, setLc] = useState(config);
                const [stats, setStats] = useState({ u: 0, s: 0, r: 0, l: false });
                const [filterPeriod, setFilterPeriod] = useState('all'); 
                const [customStart, setCustomStart] = useState('');
                const [customEnd, setCustomEnd] = useState('');
                const [searchQuery, setSearchQuery] = useState('');
                const [userResults, setUserResults] = useState([]);
                const [gid, setGid] = useState(''); const [gamt, setGamt] = useState('');

                const upd = (k, v) => setLc(p => ({...p, [k]: v}));
                
                const updateTariff = (id, field, val) => {
                    setLc(prev => ({
                        ...prev,
                        tariffs: prev.tariffs.map(t => t.id === id ? { ...t, [field]: val } : t)
                    }));
                };
                const addTariff = () => {
                    const newTariff = { id: Date.now(), name: '‚ú® –ù–æ–≤—ã–π', tokens: 100, price: 100 };
                    setLc(prev => ({ ...prev, tariffs: [...(prev.tariffs || []), newTariff] }));
                };
                const deleteTariff = (id) => {
                    if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ?")) return;
                    setLc(prev => ({ ...prev, tariffs: prev.tariffs.filter(t => t.id !== id) }));
                };

                const save = () => saveConfigToDb(lc);

                const grant = async () => {
                    if(!gid || !gamt) return;
                    try {
                        const r = window.fs.doc(window.db, "users", gid);
                        if(!(await window.fs.getDoc(r)).exists()) throw new Error();
                        await window.fs.updateDoc(r, { balance: window.fs.increment(Number(gamt)) });
                        window.Telegram.WebApp.showAlert("OK"); setGid(''); setGamt('');
                    } catch(e) { window.Telegram.WebApp.showAlert("Err"); }
                };

                const loadStats = async () => {
                    setStats(p => ({...p, l: true}));
                    const { collection, getDocs } = window.fs;
                    const usersRef = collection(window.db, "users");
                    const snapshot = await getDocs(usersRef);
                    
                    let u = 0; let balanceSum = 0; let spentSum = 0; 
                    const filteredUsers = [];
                    const q = searchQuery.toLowerCase();
                    const now = new Date();

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const regDate = new Date(data.createdAt || 0);
                        let include = true;
                        
                        if (filterPeriod === 'today') include = regDate.toDateString() === now.toDateString();
                        else if (filterPeriod === 'week') include = regDate >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        else if (filterPeriod === 'manual' && customStart && customEnd) {
                            const e = new Date(customEnd); e.setHours(23,59,59);
                            include = regDate >= new Date(customStart) && regDate <= e;
                        }

                        if (include) {
                            u++; 
                            balanceSum += (data.balance || 0); // –¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ä—É–∫–∞—Ö
                            spentSum += (data.spent || 0); // –ü–æ—Ç—Ä–∞—á–µ–Ω–æ
                            
                            if (!searchQuery || 
                                data.username?.toLowerCase().includes(q) || 
                                data.firstName?.toLowerCase().includes(q) || 
                                doc.id.includes(q)) {
                                filteredUsers.push({id: doc.id, ...data});
                            }
                        }
                    });
                    setStats({ u, balanceSum, spentSum, l: false });
                    setUserResults(filteredUsers.slice(0, 50));
                };
                
                useEffect(() => { if(tab==='stat') loadStats(); }, [tab, filterPeriod, searchQuery, customStart, customEnd]);

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="flex justify-between mb-4">
                            <button onClick={() => setActiveTab('profile')} className="text-gray-400">–ù–∞–∑–∞–¥</button>
                            <div className="bg-gray-800 rounded p-1 flex">
                                <button onClick={() => setTab('set')} className={`px-3 py-1 rounded text-xs ${tab==='set'?'bg-blue-600':'text-gray-500'}`}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                                <button onClick={() => setTab('stat')} className={`px-3 py-1 rounded text-xs ${tab==='stat'?'bg-purple-600':'text-gray-500'}`}>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                            </div>
                        </div>

                        {tab === 'set' ? (
                            <div className="space-y-4">
                                <div className="flex justify-between"><h2 className="text-xl font-bold text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><button onClick={save} className="bg-blue-600 px-4 py-2 rounded text-xs font-bold text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                                
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-blue-400 font-bold mb-2 text-xs">ü§ñ –ë–æ—Ç –¢–æ–∫–µ–Ω</h3>
                                    <input value={lc.botToken || ''} onChange={e => upd('botToken', e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs" placeholder="–¢–æ–∫–µ–Ω –æ—Ç BotFather"/>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-purple-400 font-bold mb-3 text-xs uppercase">üí∞ –≠–∫–æ–Ω–æ–º–∏–∫–∞</h3>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">–ö—É—Ä—Å (RUB –∑–∞ 1 —Ç–æ–∫–µ–Ω)</label>
                                        <input type="number" step="0.01" value={lc.tokenPriceRub} onChange={e => upd('tokenPriceRub', parseFloat(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-green-400 font-bold mb-3 text-sm uppercase">üéÅ –ë–æ–Ω—É—Å—ã</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–ù–æ–≤–∏—á–∫—É</label>
                                            <input type="number" value={lc.welcomeBonus} onChange={e => upd('welcomeBonus', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–ó–∞ –¥—Ä—É–≥–∞</label>
                                            <input type="number" value={lc.referralReward} onChange={e => upd('referralReward', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-blue-400 font-bold mb-3 text-xs uppercase">–¶–µ–Ω—ã —É—Å–ª—É–≥</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="text-[10px] text-gray-500">–§–æ—Ç–æ</label><input type="number" value={lc.priceImage} onChange={e => upd('priceImage', Number(e.target.value))} className="w-full bg-gray-900 rounded p-1 text-white border border-gray-700 text-xs"/></div>
                                        <div><label className="text-[10px] text-gray-500">–í–∏–¥–µ–æ</label><input type="number" value={lc.priceVideo} onChange={e => upd('priceVideo', Number(e.target.value))} className="w-full bg-gray-900 rounded p-1 text-white border border-gray-700 text-xs"/></div>
                                        <div><label className="text-[10px] text-gray-500">–¢–µ–∫—Å—Ç</label><input type="number" value={lc.priceText} onChange={e => upd('priceText', Number(e.target.value))} className="w-full bg-gray-900 rounded p-1 text-white border border-gray-700 text-xs"/></div>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-orange-400 font-bold mb-3 text-sm uppercase">üì¶ –¢–∞—Ä–∏—Ñ—ã</h3>
                                    <div className="space-y-3">
                                        {(lc.tariffs || []).map(t => (
                                            <div key={t.id} className="bg-gray-900 p-3 rounded-lg border border-gray-700 relative">
                                                <button onClick={() => deleteTariff(t.id)} className="absolute top-2 right-2 text-red-500 text-xs px-2 py-1"><i className="fas fa-trash"></i></button>
                                                <div className="grid grid-cols-3 gap-2 pr-6">
                                                    <div className="col-span-3">
                                                        <label className="text-[10px] text-gray-500">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                                        <input type="text" value={t.name} onChange={e => updateTariff(t.id, 'name', e.target.value)} className="w-full bg-[#1c2936] rounded p-1 text-xs text-white border border-gray-600"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] text-gray-500">–¢–æ–∫–µ–Ω–æ–≤</label>
                                                        <input type="number" value={t.tokens} onChange={e => updateTariff(t.id, 'tokens', Number(e.target.value))} className="w-full bg-[#1c2936] rounded p-1 text-xs text-white border border-gray-600"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] text-gray-500">–¶–µ–Ω–∞ (RUB)</label>
                                                        <input type="number" value={t.price} onChange={e => updateTariff(t.id, 'price', Number(e.target.value))} className="w-full bg-[#1c2936] rounded p-1 text-xs text-white border border-gray-600"/>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={addTariff} className="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg text-xs hover:border-gray-400 hover:text-white transition">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-yellow-400 font-bold mb-2 text-xs">üí≥ –û–ø–ª–∞—Ç–∞</h3>
                                    <label className="text-[10px] text-gray-500">–°—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã</label>
                                    <input value={lc.paymentLink || ''} onChange={e => upd('paymentLink', e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs mb-2"/>
                                    <label className="text-[10px] text-gray-500">QR –ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
                                    <input value={lc.qrUrl || ''} onChange={e => upd('qrUrl', e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                </div>

                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-pink-400 font-bold mb-2 text-xs">üéÅ –í—ã–¥–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</h3>
                                    <div className="flex gap-2">
                                        <input placeholder="ID" value={gid} onChange={e => setGid(e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white text-xs"/>
                                        <input placeholder="–°—É–º–º–∞" value={gamt} onChange={e => setGamt(e.target.value)} className="w-20 bg-gray-900 rounded p-2 text-white text-xs"/>
                                    </div>
                                    <button onClick={grant} className="w-full mt-2 bg-pink-600 py-1 rounded text-xs font-bold text-white">–í—ã–¥–∞—Ç—å</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                    <button onClick={() => setFilterPeriod('all')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='all'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–í—Å–µ</button>
                                    <button onClick={() => setFilterPeriod('today')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='today'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–°–µ–≥–æ–¥–Ω—è</button>
                                    <button onClick={() => setFilterPeriod('week')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='week'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–ù–µ–¥–µ–ª—è</button>
                                    <button onClick={() => setFilterPeriod('manual')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='manual'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–ü–µ—Ä–∏–æ–¥</button>
                                </div>
                                {filterPeriod === 'manual' && (
                                    <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 mb-4 grid grid-cols-2 gap-2">
                                        <input type="date" value={customStart} onChange={e => setCustomStart(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/>
                                        <input type="date" value={customEnd} onChange={e => setCustomEnd(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–Æ–∑–µ—Ä–æ–≤</div><div className="text-xl font-bold">{stats.u}</div></div>
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ä—É–∫–∞—Ö</div><div className="text-xl font-bold text-blue-400">{stats.balanceSum}</div></div>
                                    <div className="bg-gray-800 p-3 rounded-xl col-span-2"><div className="text-gray-400 text-xs">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (–û–±–æ—Ä–æ—Ç)</div><div className="text-xl font-bold text-green-400">{stats.spentSum}</div></div>
                                </div>
                                <input type="text" placeholder="–ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-gray-900 rounded-lg p-2 text-sm text-white border border-gray-700"/>
                                <div className="bg-gray-900 rounded-lg overflow-y-auto max-h-60">
                                    {userResults.map(u => (
                                        <div key={u.id} className="p-2 border-b border-gray-800 text-xs flex justify-between">
                                            <span>{u.firstName} ({u.id})</span>
                                            <span className="text-yellow-500">{u.balance}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const PayModal = () => {
                if (!payModalData) return null;
                return (
                    <div className="modal-overlay" onClick={() => setPayModalData(null)}>
                        <div className="modal-content" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-white mb-2">–û–ø–ª–∞—Ç–∞</h3>
                            <div className="text-gray-300 text-sm mb-4">–¢–∞—Ä–∏—Ñ: {payModalData.name} ({payModalData.tokens} —Ç.)</div>
                            {config.qrUrl && <div className="bg-white p-2 rounded-xl mb-4 inline-block"><img src={config.qrUrl} className="w-40 h-40 object-contain"/></div>}
                            <div className="text-2xl font-bold text-green-400 mb-4">{payModalData.price} ‚ÇΩ</div>
                            {config.paymentLink ? (
                                <a href={config.paymentLink} target="_blank" className="block w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3">–û–ø–ª–∞—Ç–∏—Ç—å</a>
                            ) : (
                                <div className="text-red-400 text-xs mb-3">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</div>
                            )}
                            <button onClick={() => setPayModalData(null)} className="w-full text-gray-500 py-2">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                );
            };

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-16 transition-all ${activeTab === id ? 'text-blue-500 scale-110' : 'text-gray-500'}`}>
                    <i className={`fas ${icon} text-xl mb-1`}></i><span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            if (isLoading) return <div className="flex h-screen items-center justify-center text-blue-500"><i className="fas fa-circle-notch fa-spin text-2xl"></i></div>;

            return (
                <div className="min-h-screen bg-[#17212b]">
                    {activeTab === 'generate' && <TabGenerate />}
                    {activeTab === 'chat' && <TabChat />}
                    {activeTab === 'profile' && <TabProfile />}
                    {activeTab === 'admin' && <TabAdmin />}
                    
                    {!(activeTab === 'chat' && fullscreenItem === 'dummy') && (
                        <div className="fixed bottom-0 left-0 right-0 bg-[#1c2936] border-t border-gray-800 pb-safe pt-2 px-6 flex justify-around z-50 h-[70px]">
                            <NavItem id="generate" icon="fa-wand-magic-sparkles" label="–ò–º–∏–¥–∂" />
                            <NavItem id="chat" icon="fa-comments" label="–ß–∞—Ç" />
                            <NavItem id="profile" icon="fa-user-circle" label="–ü—Ä–æ—Ñ–∏–ª—å" />
                        </div>
                    )}

                    {payModalData && <PayModal />}
                    {shareModalItem && <div className="modal-overlay" onClick={() => setShareModalItem(null)}>
                        <div className="modal-content" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-white mb-4">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
                            
                            {navigator.share && (
                                <button onClick={() => {
                                    navigator.share({ title: 'AI Bot', text: shareModalItem.prompt, url: shareModalItem.url }).catch(console.error);
                                    setShareModalItem(null);
                                }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3 flex items-center justify-center">
                                    <i className="fas fa-share-alt mr-2"></i> –°–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥
                                </button>
                            )}

                            <button onClick={()=>{
                                copyToClipboard(shareModalItem.url).then(()=>window.Telegram.WebApp.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!")); 
                                setShareModalItem(null)
                            }} className="w-full bg-gray-700 text-white py-3 rounded-xl font-bold flex items-center justify-center">
                                <i className="fas fa-copy mr-2"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>

                            <button onClick={() => setShareModalItem(null)} className="w-full text-gray-400 py-2 mt-2">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>}
                    {fullscreenItem && <div className="modal-overlay" onClick={() => setFullscreenItem(null)}>
                        <div className="close-fs-btn" onClick={() => setFullscreenItem(null)}>&times;</div>
                        {fullscreenItem.type === 'image' ? <img src={fullscreenItem.url} className="fullscreen-media" onClick={e=>e.stopPropagation()} /> : <video src={fullscreenItem.url} controls autoPlay className="fullscreen-media" onClick={e=>e.stopPropagation()} />}
                    </div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


