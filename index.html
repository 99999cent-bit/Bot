<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Bot</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: var(--tg-theme-bg-color, #17212b);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            /* –£–±—Ä–∞–ª–∏ overflow:hidden, —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª —Ä–∞–±–æ—Ç–∞–ª –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å fixed –º–µ–Ω—é */
            min-height: 100vh; 
            margin: 0;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .message-bubble { max-width: 85%; border-radius: 16px; padding: 12px; margin-bottom: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user-msg { background-color: #3390ec; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-msg { background-color: #2b2b2b; color: #e4e4e4; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .page-enter { opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .slide-down { animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1c2936; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #3390ec; }
        
        .tariff-card { background: linear-gradient(145deg, #2b3c4e, #1c2936); border: 1px solid #334e68; transition: transform 0.1s; position: relative; overflow: hidden; }
        .tariff-card:active { transform: scale(0.98); }

        .media-card { background: #1c2936; border-radius: 16px; overflow: hidden; margin-top: 16px; border: 1px solid #2b3c4e; }
        .media-actions { display: flex; border-top: 1px solid #2b3c4e; }
        .media-btn { flex: 1; padding: 12px; text-align: center; color: #3390ec; font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.02); }
        .media-btn:active { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, collection, getDocs, query, where 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCbzbhEn__nA9TXawnqRVU2DbZFyeJa_2U",
            authDomain: "aigenerator75-3fb8e.firebaseapp.com",
            projectId: "aigenerator75-3fb8e",
            storageBucket: "aigenerator75-3fb8e.firebasestorage.app",
            messagingSenderId: "1018038849306",
            appId: "1:1018038849306:web:462e241a3940ff591ee6a3",
            measurementId: "G-W8TPE5PLEF"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        window.db = db;
        window.fs = { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, collection, getDocs, query, where };
        window.firebaseReady = true;
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // ID –ê–¥–º–∏–Ω–∞
        const ADMIN_ID = 442529744; 

        const App = () => {
            const [activeTab, setActiveTab] = useState('generate');
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            
            // –•—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ
            const [globalHistory, setGlobalHistory] = useState([]);

            const [payModalData, setPayModalData] = useState(null);
            const [shareModalItem, setShareModalItem] = useState(null);

            const [dbUser, setDbUser] = useState({ balance: 0, referrals: 0, firstName: '', spent: 0 });
            
            const [config, setConfig] = useState({
                priceImage: 50, priceVideo: 300, priceText: 10,
                welcomeBonus: 100, referralReward: 50,
                tokenPriceRub: 1.0, 
                paymentLink: "https://yoomoney.ru", 
                qrUrl: "https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg",
                tariffs: [
                    { id: 1, name: 'üöÄ –°—Ç–∞—Ä—Ç', tokens: 100, price: 99 },
                    { id: 2, name: 'üíé –ü—Ä–æ—Ñ–∏', tokens: 500, price: 450 },
                    { id: 3, name: 'üëë –û–ª–∏–≥–∞—Ä—Ö', tokens: 1000, price: 800 }
                ]
            });

            const [chatHistory, setChatHistory] = useState([
                { role: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! –Ø AI Bot. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' }
            ]);

            useEffect(() => {
                const initApp = async () => {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();

                    let telegramUser = tg.initDataUnsafe?.user;
                    if (!telegramUser) telegramUser = { id: ADMIN_ID, first_name: '–ó–∞–≥—Ä—É–∑–∫–∞...', username: 'admin' };
                    
                    if (!window.firebaseReady) await new Promise(r => document.addEventListener('firebase-ready', r));

                    const { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion } = window.fs;
                    const db = window.db;

                    const configRef = doc(db, "settings", "global");
                    onSnapshot(configRef, (snap) => {
                        if (snap.exists()) setConfig(prev => ({ ...prev, ...snap.data() }));
                        else setDoc(configRef, config);
                    });

                    const userRef = doc(db, "users", telegramUser.id.toString());
                    const userSnap = await getDoc(userRef);

                    if (!userSnap.exists()) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const startParam = tg.initDataUnsafe?.start_param || urlParams.get('start'); 
                        const realName = telegramUser.first_name !== '–ó–∞–≥—Ä—É–∑–∫–∞...' ? telegramUser.first_name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                        await setDoc(userRef, {
                            username: telegramUser.username || '',
                            firstName: realName,
                            balance: config.welcomeBonus || 100,
                            referrals: 0,
                            spent: 0,
                            invitedBy: startParam || null,
                            createdAt: new Date().toISOString()
                        });

                        if (startParam && startParam != telegramUser.id) {
                            const refUserRef = doc(db, "users", startParam.toString());
                            updateDoc(refUserRef, {
                                referrals: increment(1),
                                balance: increment(config.referralReward || 50) 
                            }).catch(e => console.log("Ref error"));
                        }
                        setUser({ ...telegramUser, first_name: realName });
                    } else {
                        const data = userSnap.data();
                        if (telegramUser.first_name === '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                            setUser({ ...telegramUser, first_name: data.firstName || 'Admin' });
                        } else {
                            setUser(telegramUser);
                        }
                    }

                    onSnapshot(userRef, (snap) => {
                        if (snap.exists()) setDbUser(snap.data());
                    });

                    setIsLoading(false);
                };
                initApp();
            }, []);

            const saveConfigToDb = async (newConfig) => {
                const { updateDoc, doc } = window.fs;
                await updateDoc(doc(window.db, "settings", "global"), newConfig);
                window.Telegram.WebApp.showAlert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
            };

            const handleGenerate = async (type, prompt) => {
                if (user.id === ADMIN_ID) return true;
                const price = type === 'image' ? config.priceImage : config.priceVideo;
                if (dbUser.balance < price) return window.Telegram.WebApp.showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤! –ù—É–∂–Ω–æ ${price}`);
                await window.fs.updateDoc(window.fs.doc(window.db, "users", user.id.toString()), { balance: window.fs.increment(-price) });
                return true; 
            };

            const handleSendChat = async (text) => {
                if (user.id === ADMIN_ID) return true;
                if (dbUser.balance < config.priceText) return window.Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤!");
                await window.fs.updateDoc(window.fs.doc(window.db, "users", user.id.toString()), { balance: window.fs.increment(-config.priceText) });
                return true;
            };

            // --- TABS ---

            const TabGenerate = () => {
                const [genType, setGenType] = useState('image');
                const [prompt, setPrompt] = useState('');
                const [isProc, setIsProc] = useState(false);

                const go = async () => {
                    if (!prompt) return;
                    setIsProc(true);
                    
                    const success = await handleGenerate(genType, prompt);
                    if (success) {
                        setTimeout(() => {
                            setIsProc(false);
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                            const newUrl = genType === 'image' 
                                ? `https://placehold.co/600x600/1a1a1a/FFF.png?text=${encodeURIComponent(prompt)}` 
                                : "https://www.w3schools.com/html/mov_bbb.mp4";
                            
                            const newItem = {
                                id: Date.now(),
                                type: genType,
                                url: newUrl,
                                prompt: prompt,
                                date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                            };
                            setGlobalHistory(prev => [newItem, ...prev]);
                            
                            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        }, 2500);
                    } else {
                        setIsProc(false);
                    }
                };

                const downloadMedia = async (url, filename) => {
                    // –ú–µ—Ç–æ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Blob
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error("Network error");
                        const blob = await response.blob();
                        const blobUrl = window.URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.download = filename || `file_${Date.now()}`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(blobUrl);
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ç–æ, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        window.Telegram.WebApp.showAlert("–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É Downloads.");
                    } catch (e) {
                        window.Telegram.WebApp.openLink(url);
                    }
                };

                const openShareModal = (item) => {
                    setShareModalItem(item);
                };

                const filteredHistory = globalHistory.filter(item => item.type === genType);

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="flex justify-between mb-4">
                            <span className="text-gray-400">–ë–∞–ª–∞–Ω—Å: <b className="text-yellow-400">{user.id === ADMIN_ID ? '‚àû (Admin)' : dbUser.balance}</b></span>
                        </div>
                        <div className="flex bg-gray-800 rounded-lg p-1 mb-4">
                            <button onClick={() => setGenType('image')} className={`flex-1 py-2 rounded font-bold text-sm transition-all ${genType === 'image' ? 'bg-blue-600 shadow-lg' : 'text-gray-500'}`}>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ({config.priceImage})</button>
                            <button onClick={() => setGenType('video')} className={`flex-1 py-2 rounded font-bold text-sm transition-all ${genType === 'video' ? 'bg-purple-600 shadow-lg' : 'text-gray-500'}`}>–í–∏–¥–µ–æ ({config.priceVideo})</button>
                        </div>
                        <textarea value={prompt} onChange={e => setPrompt(e.target.value)} placeholder={`–û–ø–∏—à–∏ ${genType === 'image' ? '–∫–∞—Ä—Ç–∏–Ω–∫—É' : '–≤–∏–¥–µ–æ'}...`} className="w-full bg-gray-800 rounded-xl p-4 mb-4 text-white min-h-[100px] border border-gray-700 focus:border-blue-500 outline-none"></textarea>
                        <button onClick={go} disabled={isProc} className={`w-full py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all ${genType === 'image' ? 'bg-blue-600' : 'bg-purple-600'}`}>
                            {isProc ? <i className="fas fa-spinner fa-spin"></i> : "üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"}
                        </button>
                        
                        <div className="mt-6 space-y-4">
                            {filteredHistory.length > 0 && <h3 className="text-gray-400 text-sm font-bold pl-1">–í–∞—à–∏ {genType === 'image' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' : '–≤–∏–¥–µ–æ'}:</h3>}
                            
                            {filteredHistory.length === 0 && globalHistory.length > 0 && (
                                <div className="text-center text-gray-500 text-sm py-4 bg-gray-800/50 rounded-xl">
                                    –ü—É—Å—Ç–æ. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É.
                                </div>
                            )}
                            
                            {filteredHistory.map(item => (
                                <div key={item.id} className="media-card slide-down">
                                    <div className="p-3 bg-[#233040] border-b border-[#2b3c4e] flex justify-between items-center">
                                        <span className="text-xs text-gray-400 truncate max-w-[70%]">{item.prompt}</span>
                                        <span className="text-[10px] text-gray-500">{item.date}</span>
                                    </div>
                                    <div className="bg-black flex justify-center items-center min-h-[200px]">
                                        {item.type === 'image' ? (
                                            <img src={item.url} className="max-w-full max-h-[400px] object-contain" alt="Gen" />
                                        ) : (
                                            <video src={item.url} controls className="max-w-full max-h-[400px]" />
                                        )}
                                    </div>
                                    <div className="media-actions">
                                        <button onClick={() => downloadMedia(item.url, `${item.type}_${item.id}.${item.type==='image'?'png':'mp4'}`)} className="media-btn border-r border-[#2b3c4e]">
                                            <i className="fas fa-file-download mr-2"></i> –°–∫–∞—á–∞—Ç—å
                                        </button>
                                        <button onClick={() => openShareModal(item)} className="media-btn">
                                            <i className="fas fa-share-nodes mr-2"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const TabChat = () => {
                const [txt, setTxt] = useState('');
                const endRef = useRef(null);

                const send = async () => {
                    if (!txt.trim()) return;
                    const ok = await handleSendChat(txt);
                    if (ok) {
                        setChatHistory(prev => [...prev, { role: 'user', text: txt }]);
                        const q = txt; 
                        setTxt('');
                        setTimeout(() => {
                            setChatHistory(prev => [...prev, { role: 'ai', text: `–û—Ç–≤–µ—Ç –Ω–∞: ${q}` }]);
                        }, 800);
                    }
                };

                useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

                return (
                    // pb-[90px] —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–æ—Å—å –∑–∞ –Ω–∏–∂–Ω–∏–º –º–µ–Ω—é
                    <div className="page-enter flex flex-col h-full relative pb-[90px]">
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {chatHistory.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`message-bubble ${m.role === 'user' ? 'user-msg' : 'ai-msg'}`}>{m.text}</div>
                                </div>
                            ))}
                            <div ref={endRef} />
                        </div>
                        
                        <div className="bg-[#17212b] p-3 border-t border-gray-800 flex items-center gap-2 shrink-0">
                            <input 
                                value={txt} 
                                onChange={e => setTxt(e.target.value)} 
                                placeholder={`–í–æ–ø—Ä–æ—Å (${user.id === ADMIN_ID ? 0 : config.priceText} —Ç)...`}
                                className="flex-1 bg-gray-800 text-white rounded-full px-4 py-3 outline-none border border-gray-600 focus:border-blue-500"
                            />
                            <button onClick={send} className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg"><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                );
            };

            const TabProfile = () => {
                const link = `https://99999cent-bit.github.io/Bot/?start=${user.id}`;
                const [buyAmount, setBuyAmount] = useState(100);
                
                const totalPrice = Math.ceil(buyAmount * config.tokenPriceRub);

                const handleCustomBuy = () => {
                    if (buyAmount < 100) {
                        return window.Telegram.WebApp.showAlert("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ ‚Äî 100 —Ç–æ–∫–µ–Ω–æ–≤!");
                    }
                    setPayModalData({ name: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞', tokens: buyAmount, price: totalPrice });
                };
                
                const handleTariffBuy = (tariff) => {
                     setPayModalData({ name: tariff.name, tokens: tariff.tokens, price: tariff.price });
                };

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 mb-4 border border-gray-700 shadow-lg">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h2 className="text-2xl font-bold">{user.first_name}</h2>
                                    <p className="text-gray-400 text-sm">ID: {user.id}</p>
                                </div>
                                <div className="text-right">
                                    <span className="block text-4xl font-bold text-yellow-400">
                                        {user.id === ADMIN_ID ? '‚àû' : dbUser.balance}
                                    </span>
                                    <span className="text-xs text-gray-400 uppercase tracking-wider">–¢–æ–∫–µ–Ω–æ–≤</span>
                                </div>
                            </div>
                            
                            {user.id === ADMIN_ID && (
                                <button onClick={() => setActiveTab('admin')} className="w-full bg-gray-700 py-2 rounded-xl font-medium text-sm border border-gray-600 mb-2">
                                    <i className="fas fa-cog mr-2"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                                </button>
                            )}
                        </div>

                        <h3 className="text-lg font-bold mb-3 pl-1 text-white">üì¶ –ì–æ—Ç–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã</h3>
                        <div className="grid gap-3 mb-6">
                            {(config.tariffs || []).map(tariff => (
                                <div key={tariff.id} className="tariff-card rounded-xl p-4 flex justify-between items-center cursor-pointer" 
                                     onClick={() => handleTariffBuy(tariff)}>
                                    <div className="flex items-center">
                                        <div className="bg-blue-600/20 text-blue-400 w-10 h-10 rounded-full flex items-center justify-center mr-3">
                                            <i className="fas fa-bolt"></i>
                                        </div>
                                        <div>
                                            <div className="font-bold text-base text-white">{tariff.name}</div>
                                            <div className="text-gray-400 text-xs">{tariff.tokens} —Ç–æ–∫–µ–Ω–æ–≤</div>
                                        </div>
                                    </div>
                                    <div className="bg-blue-600 px-3 py-1.5 rounded-lg font-bold text-sm text-white shadow">
                                        {tariff.price} ‚ÇΩ
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="bg-gray-800 rounded-2xl p-5 border border-gray-700 mb-4">
                            <h3 className="font-bold text-lg mb-3 text-white"><i className="fas fa-calculator text-gray-400 mr-2"></i>–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
                            
                            <div className="mb-4">
                                <label className="text-xs text-gray-400 mb-1 block">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∏–Ω–∏–º—É–º 100):</label>
                                <div className="flex items-center bg-gray-900 rounded-xl border border-gray-600 overflow-hidden">
                                    <input 
                                        type="number" 
                                        value={buyAmount}
                                        onChange={e => setBuyAmount(Math.max(1, Number(e.target.value)))}
                                        className="flex-1 bg-transparent p-3 text-white outline-none font-mono"
                                    />
                                    <span className="pr-4 text-gray-500 text-sm">—à—Ç.</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">–ö—É—Ä—Å: 1 —Ç–æ–∫–µ–Ω = {config.tokenPriceRub} ‚ÇΩ</p>
                            </div>

                            <button onClick={handleCustomBuy} className="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex justify-center items-center">
                                <span>–ö—É–ø–∏—Ç—å –∑–∞ {totalPrice} ‚ÇΩ</span>
                            </button>
                        </div>

                        <div className="bg-gray-800 rounded-2xl p-5 border border-gray-700">
                            <h3 className="font-bold text-lg mb-2 text-white">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</h3>
                            <p className="text-sm text-gray-300 mb-4">
                                –ù–∞–≥—Ä–∞–¥–∞: <b className="text-yellow-400">{config.referralReward} —Ç–æ–∫–µ–Ω–æ–≤</b>
                            </p>
                            <div className="flex gap-2">
                                <div className="bg-black/40 p-3 rounded-lg flex-1 overflow-hidden">
                                    <p className="text-xs text-gray-400 truncate">{link}</p>
                                </div>
                                <button onClick={() => {navigator.clipboard.writeText(link); window.Telegram.WebApp.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");}} className="bg-blue-600 px-4 rounded-lg font-bold text-sm">
                                    –ö–æ–ø–∏—è
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const TabAdmin = () => {
                const [subTab, setSubTab] = useState('settings'); 
                const [localConfig, setLocalConfig] = useState(config);
                
                const [stats, setStats] = useState({ users: 0, sold: 0, revenue: 0, loading: false });
                const [filterPeriod, setFilterPeriod] = useState('all'); 
                const [customStart, setCustomStart] = useState('');
                const [customEnd, setCustomEnd] = useState('');

                const [searchQuery, setSearchQuery] = useState('');
                const [userResults, setUserResults] = useState([]);

                const [grantId, setGrantId] = useState('');
                const [grantAmount, setGrantAmount] = useState('');

                const handleChange = (field, val) => {
                    setLocalConfig(prev => ({ ...prev, [field]: val }));
                };

                const updateTariff = (id, field, val) => {
                    setLocalConfig(prev => ({
                        ...prev,
                        tariffs: prev.tariffs.map(t => t.id === id ? { ...t, [field]: val } : t)
                    }));
                };
                
                const deleteTariff = (id) => {
                    if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ?")) return;
                    setLocalConfig(prev => ({ ...prev, tariffs: prev.tariffs.filter(t => t.id !== id) }));
                };
                
                const addTariff = () => {
                    const newTariff = { id: Date.now(), name: '‚ú® –ù–æ–≤—ã–π', tokens: 100, price: 100 };
                    setLocalConfig(prev => ({ ...prev, tariffs: [...(prev.tariffs || []), newTariff] }));
                };

                const save = () => {
                    saveConfigToDb(localConfig);
                };

                const handleGrantTokens = async () => {
                    if(!grantId || !grantAmount) return window.Telegram.WebApp.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –∏ –°—É–º–º—É");
                    try {
                        const { doc, getDoc, updateDoc, increment } = window.fs;
                        const targetUserRef = doc(window.db, "users", grantId.toString());
                        const snap = await getDoc(targetUserRef);
                        if(!snap.exists()) {
                            window.Telegram.WebApp.showAlert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                            return;
                        }
                        await updateDoc(targetUserRef, { balance: increment(Number(grantAmount)) });
                        window.Telegram.WebApp.showAlert(`–£—Å–ø–µ—à–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ ${grantAmount} —Ç–æ–∫–µ–Ω–æ–≤!`);
                        setGrantId(''); setGrantAmount('');
                    } catch(e) {
                        console.error(e);
                        window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏");
                    }
                };

                const loadStats = async () => {
                    setStats(p => ({...p, loading: true}));
                    const { collection, getDocs } = window.fs;
                    const usersRef = collection(window.db, "users");
                    const snapshot = await getDocs(usersRef);
                    
                    let totalUsers = 0; let totalSold = 0; let totalRevenue = 0; 
                    const now = new Date();
                    const filteredUsers = [];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const regDate = new Date(data.createdAt || 0);
                        let include = true;
                        
                        if (filterPeriod === 'today') include = regDate.toDateString() === now.toDateString();
                        else if (filterPeriod === 'week') include = regDate >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        else if (filterPeriod === 'manual') {
                            if (customStart && customEnd) {
                                const e = new Date(customEnd); e.setHours(23,59,59);
                                include = regDate >= new Date(customStart) && regDate <= e;
                            }
                        }

                        if (include) {
                            totalUsers++; totalSold += (data.balance || 0); totalRevenue += (data.spent || 0); 
                        }
                        
                        if (searchQuery) {
                            const q = searchQuery.toLowerCase();
                            if (data.username?.toLowerCase().includes(q) || data.firstName?.toLowerCase().includes(q) || doc.id.includes(q)) {
                                filteredUsers.push({id: doc.id, ...data});
                            }
                        }
                    });
                    setStats({ users: totalUsers, sold: totalSold, revenue: totalRevenue, loading: false });
                    setUserResults(filteredUsers);
                };

                useEffect(() => { if (subTab === 'stats') loadStats(); }, [subTab, filterPeriod, searchQuery, customStart, customEnd]);

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={() => setActiveTab('profile')} className="text-gray-400 flex items-center"><i className="fas fa-arrow-left mr-2"></i> –ù–∞–∑–∞–¥</button>
                            <div className="bg-gray-800 rounded-lg p-1 flex">
                                <button onClick={() => setSubTab('settings')} className={`px-3 py-1 rounded text-xs font-bold ${subTab==='settings'?'bg-blue-600':'text-gray-500'}`}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                                <button onClick={() => setSubTab('stats')} className={`px-3 py-1 rounded text-xs font-bold ${subTab==='stats'?'bg-purple-600':'text-gray-500'}`}>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                            </div>
                        </div>

                        {subTab === 'settings' ? (
                            <div className="space-y-4 page-enter">
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-xl font-bold text-white">‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥</h2>
                                    <button onClick={save} className="bg-blue-600 px-4 py-2 rounded-lg font-bold text-xs shadow-lg active:scale-95">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-purple-400 font-bold mb-3 text-xs uppercase">üí∞ –≠–∫–æ–Ω–æ–º–∏–∫–∞</h3>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">–ö—É—Ä—Å (RUB –∑–∞ 1 —Ç–æ–∫–µ–Ω)</label>
                                        <input type="number" step="0.01" value={localConfig.tokenPriceRub} onChange={e => handleChange('tokenPriceRub', parseFloat(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-green-400 font-bold mb-3 text-sm uppercase">üéÅ –ë–æ–Ω—É—Å—ã</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–ù–æ–≤–∏—á–∫—É</label>
                                            <input type="number" value={localConfig.welcomeBonus} onChange={e => handleChange('welcomeBonus', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–ó–∞ –¥—Ä—É–≥–∞</label>
                                            <input type="number" value={localConfig.referralReward} onChange={e => handleChange('referralReward', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-pink-400 font-bold mb-3 text-xs uppercase">üéÅ –ù–∞—á–∏—Å–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="col-span-2">
                                            <input type="text" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value={grantId} onChange={e => setGrantId(e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-sm"/>
                                        </div>
                                        <div>
                                            <input type="number" placeholder="–°—É–º–º–∞" value={grantAmount} onChange={e => setGrantAmount(e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-sm"/>
                                        </div>
                                    </div>
                                    <button onClick={handleGrantTokens} className="w-full mt-2 bg-pink-600 hover:bg-pink-500 py-2 rounded-lg font-bold text-xs">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-orange-400 font-bold mb-3 text-sm uppercase">üì¶ –¢–∞—Ä–∏—Ñ—ã</h3>
                                    <div className="space-y-3">
                                        {(localConfig.tariffs || []).map(t => (
                                            <div key={t.id} className="bg-gray-900 p-3 rounded-lg border border-gray-700 relative">
                                                <button onClick={() => deleteTariff(t.id)} className="absolute top-2 right-2 text-red-500 text-xs px-2 py-1"><i className="fas fa-trash"></i></button>
                                                <div className="grid grid-cols-3 gap-2 pr-6">
                                                    <div className="col-span-3">
                                                        <label className="text-[10px] text-gray-500">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                                        <input type="text" value={t.name} onChange={e => updateTariff(t.id, 'name', e.target.value)} className="w-full bg-[#1c2936] rounded p-1 text-sm text-white border border-gray-600"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] text-gray-500">–¢–æ–∫–µ–Ω–æ–≤</label>
                                                        <input type="number" value={t.tokens} onChange={e => updateTariff(t.id, 'tokens', Number(e.target.value))} className="w-full bg-[#1c2936] rounded p-1 text-sm text-white border border-gray-600"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] text-gray-500">–¶–µ–Ω–∞ (RUB)</label>
                                                        <input type="number" value={t.price} onChange={e => updateTariff(t.id, 'price', Number(e.target.value))} className="w-full bg-[#1c2936] rounded p-1 text-sm text-white border border-gray-600"/>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={addTariff} className="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg text-sm hover:border-gray-400 hover:text-white transition">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-blue-400 font-bold mb-3 text-xs uppercase">–¶–µ–Ω—ã —É—Å–ª—É–≥</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–§–æ—Ç–æ</label>
                                            <input type="number" value={localConfig.priceImage} onChange={e => handleChange('priceImage', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">–í–∏–¥–µ–æ</label>
                                            <input type="number" value={localConfig.priceVideo} onChange={e => handleChange('priceVideo', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-xs text-gray-500 block mb-1">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                                            <input type="number" value={localConfig.priceText} onChange={e => handleChange('priceText', Number(e.target.value))} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700"/>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                    <h3 className="text-yellow-400 font-bold mb-3 text-sm uppercase">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">URL –û–ø–ª–∞—Ç—ã</label>
                                            <input type="text" value={localConfig.paymentLink} onChange={e => handleChange('paymentLink', e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">URL QR-–∫–æ–¥–∞</label>
                                            <input type="text" value={localConfig.qrUrl} onChange={e => handleChange('qrUrl', e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 page-enter">
                                <h2 className="text-xl font-bold text-white mb-2">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                    <button onClick={() => setFilterPeriod('all')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='all'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–í—Å–µ</button>
                                    <button onClick={() => setFilterPeriod('today')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='today'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–°–µ–≥–æ–¥–Ω—è</button>
                                    <button onClick={() => setFilterPeriod('week')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='week'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>–ù–µ–¥–µ–ª—è</button>
                                    <button onClick={() => setFilterPeriod('manual')} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${filterPeriod==='manual'?'bg-white text-black border-white':'border-gray-600 text-gray-400'}`}>üìÖ –ü–µ—Ä–∏–æ–¥</button>
                                </div>
                                {filterPeriod === 'manual' && (
                                    <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 mb-4 grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-[10px] text-gray-400">–° –¥–∞—Ç—ã:</label>
                                            <input type="date" value={customStart} onChange={e => setCustomStart(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/>
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-gray-400">–ü–æ –¥–∞—Ç—É:</label>
                                            <input type="date" value={customEnd} onChange={e => setCustomEnd(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/>
                                        </div>
                                    </div>
                                )}
                                {stats.loading ? <div className="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div> : (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700">
                                            <div className="text-gray-400 text-xs">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π</div>
                                            <div className="text-xl font-bold text-white">{stats.users}</div>
                                        </div>
                                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700">
                                            <div className="text-gray-400 text-xs">–¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ä—É–∫–∞—Ö</div>
                                            <div className="text-xl font-bold text-blue-400">{stats.sold}</div>
                                        </div>
                                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 col-span-2">
                                            <div className="text-gray-400 text-xs">–û–±–æ—Ä–æ—Ç (RUB)</div>
                                            <div className="text-2xl font-bold text-green-400">{stats.revenue} ‚ÇΩ</div>
                                        </div>
                                    </div>
                                )}
                                <div className="mt-6">
                                    <h3 className="text-sm font-bold text-gray-300 mb-2">–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h3>
                                    <input type="text" placeholder="ID –∏–ª–∏ –ò–º—è..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-gray-900 rounded-lg p-2 text-sm text-white border border-gray-700 mb-2"/>
                                    {searchQuery && (
                                        <div className="bg-gray-900 rounded-lg overflow-hidden border border-gray-800 max-h-40 overflow-y-auto">
                                            {userResults.length === 0 ? <div className="p-2 text-xs text-gray-500">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</div> : userResults.map(u => (
                                                <div key={u.id} className="p-2 border-b border-gray-800 text-xs flex justify-between">
                                                    <span>{u.firstName}</span>
                                                    <span className="text-yellow-500">{u.balance} —Ç.</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const PayModal = () => {
                if (!payModalData) return null;
                const { name, price, tokens } = payModalData;
                return (
                    <div className="modal-overlay" onClick={() => setPayModalData(null)}>
                        <div className="modal-content" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-white mb-1">–û–ø–ª–∞—Ç–∞</h3>
                            <div className="text-blue-400 font-bold mb-4">{name}</div>
                            <div className="text-gray-400 text-sm mb-4">–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ: <b className="text-white">{tokens} —Ç–æ–∫–µ–Ω–æ–≤</b></div>
                            <div className="bg-white p-2 rounded-xl mb-4 inline-block">
                                <img src={config.qrUrl} alt="QR" className="w-40 h-40 object-contain"/>
                            </div>
                            <div className="text-center mb-4"><span className="text-2xl font-bold text-green-400">{price} ‚ÇΩ</span></div>
                            <a href={config.paymentLink} target="_blank" className="block w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3 shadow-lg transform active:scale-95 transition">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</a>
                            <button onClick={() => setPayModalData(null)} className="w-full text-gray-400 py-2">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                );
            };

            const ShareModal = () => {
                if (!shareModalItem) return null;
                const { url, prompt } = shareModalItem;

                const copyLink = () => {
                    navigator.clipboard.writeText(url);
                    window.Telegram.WebApp.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                    setShareModalItem(null);
                };

                const nativeShare = () => {
                    if (navigator.share) {
                        navigator.share({
                            title: 'AI Generator',
                            text: `–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ: ${prompt}`,
                            url: url
                        }).then(() => setShareModalItem(null)).catch(console.error);
                    } else {
                        window.Telegram.WebApp.showAlert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–µ—Ä–∏–Ω–≥.");
                    }
                };

                return (
                    <div className="modal-overlay" onClick={() => setShareModalItem(null)}>
                        <div className="modal-content" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-white mb-4">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
                            <button onClick={nativeShare} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3 flex items-center justify-center">
                                <i className="fas fa-paper-plane mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å...
                            </button>
                            <button onClick={copyLink} className="w-full bg-gray-700 text-white py-3 rounded-xl font-bold mb-3 flex items-center justify-center">
                                <i className="fas fa-link mr-2"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <button onClick={() => setShareModalItem(null)} className="w-full text-gray-400 py-2">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                );
            };

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-16 transition-all ${activeTab === id ? 'text-blue-500 scale-110' : 'text-gray-500'}`}>
                    <i className={`fas ${icon} text-xl mb-1`}></i>
                    <span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            if (isLoading) return <div className="flex h-screen items-center justify-center text-blue-500"><i className="fas fa-circle-notch fa-spin text-2xl"></i></div>;

            return (
                <div className="min-h-screen bg-[#17212b]">
                    {activeTab === 'generate' && <TabGenerate />}
                    {activeTab === 'chat' && <TabChat />}
                    {activeTab === 'profile' && <TabProfile />}
                    {activeTab === 'admin' && <TabAdmin />}
                    
                    <div className="fixed bottom-0 left-0 right-0 bg-[#1c2936] border-t border-gray-800 pb-safe pt-2 px-6 flex justify-around z-50 h-[70px]">
                        <NavItem id="generate" icon="fa-wand-magic-sparkles" label="–ò–º–∏–¥–∂" />
                        <NavItem id="chat" icon="fa-comments" label="–ß–∞—Ç" />
                        <NavItem id="profile" icon="fa-user-circle" label="–ü—Ä–æ—Ñ–∏–ª—å" />
                    </div>

                    {payModalData && <PayModal />}
                    {shareModalItem && <ShareModal />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
