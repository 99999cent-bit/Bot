<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Bot Pro</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: var(--tg-theme-bg-color, #17212b);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            min-height: 100vh; 
            margin: 0;
            padding-bottom: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .message-bubble { max-width: 85%; border-radius: 16px; padding: 12px; margin-bottom: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user-msg { background-color: #3390ec; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-msg { background-color: #2b2b2b; color: #e4e4e4; align-self: flex-start; border-bottom-left-radius: 4px; }
        .admin-msg { background-color: #e05353; color: white; align-self: flex-start; border-bottom-left-radius: 4px; }
        .support-user { background-color: #3390ec; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .support-admin { background-color: #2b2b2b; color: #e4e4e4; align-self: flex-start; border-bottom-left-radius: 4px; }

        .page-enter { opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .slide-down { animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1c2936; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #3390ec; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        
        .fullscreen-media { max-width: 100%; max-height: 80vh; object-fit: contain; }
        .close-fs-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 101; cursor: pointer; }

        .tariff-card { background: linear-gradient(145deg, #2b3c4e, #1c2936); border: 1px solid #334e68; transition: transform 0.1s; position: relative; overflow: hidden; }
        .tariff-card:active { transform: scale(0.98); }

        .media-card { background: #1c2936; border-radius: 16px; overflow: hidden; margin-top: 16px; border: 1px solid #2b3c4e; position: relative; }
        .media-actions { display: flex; border-top: 1px solid #2b3c4e; }
        .media-btn { flex: 1; padding: 12px; text-align: center; color: #3390ec; font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.02); }
        .media-btn:active { background: rgba(255,255,255,0.05); }

        .chat-input-area { position: fixed; bottom: 0; left: 0; right: 0; background: #17212b; padding: 10px; border-top: 1px solid #2b2b2b; z-index: 50; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        
        .chat-item { background: #233040; border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .chat-item:active { transform: scale(0.98); background: #2b3c4e; }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: #ff4d4d; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: transform 0.2s; }
        .delete-btn:active { transform: scale(0.9); background: rgba(255,0,0,0.2); }
        
        .tab-btn { flex: 1; padding: 8px; font-size: 12px; font-weight: bold; border-radius: 8px; transition: all 0.2s; color: #8a9aa9; }
        .tab-btn.active { background: #3390ec; color: white; }

        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #555; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .custom-checkbox.checked { background: #3390ec; border-color: #3390ec; }
        .custom-checkbox i { font-size: 12px; color: white; display: none; }
        .custom-checkbox.checked i { display: block; }
        
        .msg-badge { background: #e05353; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }

        /* –°—Ç–∞—Ç—É—Å—ã –≤ –∞–¥–º–∏–Ω–∫–µ */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-green { background: #22c55e; box-shadow: 0 0 5px #22c55e; } /* –û–Ω–ª–∞–π–Ω */
        .status-yellow { background: #eab308; } /* –ù–µ –±—ã–ª 4 –¥–Ω—è */
        .status-gray { background: #6b7280; } /* –û–±—ã—á–Ω—ã–π */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, collection, getDocs, query, where, addDoc, serverTimestamp, deleteDoc, writeBatch, orderBy, deleteField
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbzbhEn__nA9TXawnqRVU2DbZFyeJa_2U",
            authDomain: "aigenerator75-3fb8e.firebaseapp.com",
            projectId: "aigenerator75-3fb8e",
            storageBucket: "aigenerator75-3fb8e.firebasestorage.app",
            messagingSenderId: "1018038849306",
            appId: "1:1018038849306:web:462e241a3940ff591ee6a3",
            measurementId: "G-W8TPE5PLEF"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        window.db = db;
        window.fs = { 
            doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, 
            collection, getDocs, query, where, addDoc, serverTimestamp, deleteDoc, writeBatch, orderBy, deleteField 
        };
        window.firebaseReady = true;
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        const ADMIN_ID = 442529744; 
        const DEFAULT_BASE_URL = "https://99999cent-bit.github.io/Bot/"; 

        const copyToClipboard = async (text) => {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    return true;
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                }
            } catch (err) {
                return false;
            }
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('generate');
            const [genType, setGenType] = useState('image'); 
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [globalHistory, setGlobalHistory] = useState([]);
            const [payModalData, setPayModalData] = useState(null);
            const [shareModalItem, setShareModalItem] = useState(null);
            const [fullscreenItem, setFullscreenItem] = useState(null); 
            const [dbUser, setDbUser] = useState({ balance: 0, referrals: 0, firstName: '', spent: 0, totalDonated: 0, lastActiveAt: null });
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
            const [notification, setNotification] = useState(null); 
            const [supportModalOpen, setSupportModalOpen] = useState(false); 
            
            const [historyModalUser, setHistoryModalUser] = useState(null);
            const [grantModalUser, setGrantModalUser] = useState(null);
            const [modalGrantAmount, setModalGrantAmount] = useState('');
            const [unreadSupportCount, setUnreadSupportCount] = useState(0);

            const [config, setConfig] = useState({
                priceImage: 50, priceVideo: 300, priceText: 10,
                welcomeBonus: 100, referralReward: 50,
                tokenPriceRub: 1.0, 
                paymentLink: "", 
                qrUrl: "https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg",
                botToken: "",
                referralBaseUrl: DEFAULT_BASE_URL,
                tariffs: [
                    { id: 1, name: 'üöÄ –°—Ç–∞—Ä—Ç', tokens: 100, price: 99 },
                    { id: 2, name: 'üíé –ü—Ä–æ—Ñ–∏', tokens: 500, price: 450 },
                    { id: 3, name: 'üëë –û–ª–∏–≥–∞—Ä—Ö', tokens: 1000, price: 800 }
                ]
            });

            const longPressTimer = useRef(null);

            useEffect(() => {
                const initApp = async () => {
                    try {
                        const tg = window.Telegram.WebApp;
                        tg.ready();
                        tg.expand();
                        tg.enableClosingConfirmation();

                        let telegramUser = tg.initDataUnsafe?.user;
                        if (!telegramUser) {
                             // telegramUser = { id: ADMIN_ID, first_name: 'Admin', username: 'admin' }; // DEBUG
                             if (!telegramUser) {
                                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;color:white;text-align:center;background:#17212b;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç.</div>';
                                return;
                             }
                        }
                        
                        if (!window.firebaseReady) await new Promise(r => document.addEventListener('firebase-ready', r));

                        const { doc, getDoc, setDoc, updateDoc, onSnapshot, increment, collection, query, where, serverTimestamp } = window.fs;
                        const db = window.db;

                        const configRef = doc(db, "settings", "global");
                        const configSnap = await getDoc(configRef);
                        let currentWelcomeBonus = 100, currentReferralReward = 50;

                        if (configSnap.exists()) {
                            const data = configSnap.data();
                            setConfig(prev => ({ ...prev, ...data }));
                            currentWelcomeBonus = data.welcomeBonus ?? 100;
                            currentReferralReward = data.referralReward ?? 50;
                        } else { setDoc(configRef, config); }
                        
                        onSnapshot(configRef, (snap) => { if(snap.exists()) setConfig(prev => ({ ...prev, ...snap.data() })); });

                        const userRef = doc(db, "users", telegramUser.id.toString());
                        const userSnap = await getDoc(userRef);

                        // –û–±–Ω–æ–≤–ª—è–µ–º "–û–Ω–ª–∞–π–Ω" —Å—Ç–∞—Ç—É—Å
                        const updateOnline = () => updateDoc(userRef, { lastActiveAt: serverTimestamp() }).catch(()=>{});

                        if (!userSnap.exists()) {
                            const startParam = tg.initDataUnsafe?.start_param;
                            await setDoc(userRef, {
                                username: telegramUser.username || '',
                                firstName: telegramUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                                balance: currentWelcomeBonus,
                                referrals: 0, spent: 0, totalDonated: 0,
                                invitedBy: startParam || null,
                                createdAt: new Date().toISOString(),
                                lastActiveAt: serverTimestamp()
                            });
                            logTransaction(telegramUser.id.toString(), 'bonus', currentWelcomeBonus, 0, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è');
                            if (startParam && startParam != telegramUser.id) {
                                const refUserRef = doc(db, "users", startParam.toString());
                                const refSnap = await getDoc(refUserRef);
                                if(refSnap.exists()){
                                    updateDoc(refUserRef, { referrals: increment(1), balance: increment(currentReferralReward) });
                                    logTransaction(startParam.toString(), 'bonus', currentReferralReward, 0, '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞');
                                }
                            }
                        } else {
                            updateOnline();
                        }
                        
                        setUser({ ...telegramUser, first_name: telegramUser.first_name || 'User' });
                        
                        onSnapshot(userRef, (snap) => {
                            if (snap.exists()) {
                                const data = snap.data();
                                setDbUser(data);
                                if (data.notification) {
                                    setNotification(data.notification);
                                    updateDoc(userRef, { notification: window.fs.deleteField() });
                                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                                }
                            }
                        });

                        const historyRef = collection(db, "users", telegramUser.id.toString(), "history");
                        onSnapshot(historyRef, (snapshot) => {
                            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            list.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                            setGlobalHistory(list);
                        });

                        if (telegramUser.id === ADMIN_ID) {
                            const qSupport = query(collection(db, "support_tickets"), where("status", "==", "open"), where("hasUnreadAdmin", "==", true));
                            onSnapshot(qSupport, (snap) => setUnreadSupportCount(snap.size));
                        }

                    } catch (e) {
                        console.error("Init Error:", e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                initApp();
            }, []);

            const logTransaction = async (userId, type, amount, rubAmount, desc) => {
                try {
                    const { addDoc, collection, serverTimestamp } = window.fs;
                    await addDoc(collection(window.db, "users", userId, "transactions"), {
                        type, amount, amountRub: rubAmount || 0, description: desc, createdAt: serverTimestamp(), dateStr: new Date().toLocaleString()
                    });
                } catch(e) {}
            };

            const saveConfigToDb = async (newConfig) => {
                const { updateDoc, doc } = window.fs;
                await updateDoc(doc(window.db, "settings", "global"), newConfig);
                window.Telegram.WebApp.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            };

            const handleSpend = async (amount, desc) => {
                if (user.id === ADMIN_ID) return true;
                if (dbUser.balance < amount) {
                    window.Telegram.WebApp.showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤! –ù—É–∂–Ω–æ ${amount}`);
                    return false;
                }
                await window.fs.updateDoc(window.fs.doc(window.db, "users", user.id.toString()), { 
                    balance: window.fs.increment(-amount),
                    spent: window.fs.increment(1),
                    lastActiveAt: window.fs.serverTimestamp()
                });
                logTransaction(user.id.toString(), 'spend', amount, 0, desc || '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è');
                return true; 
            };

            const processPurchase = async (tokens, priceRub, name) => {
                const { updateDoc, doc, increment } = window.fs;
                await updateDoc(doc(window.db, "users", user.id.toString()), { 
                    balance: increment(tokens),
                    totalDonated: increment(priceRub),
                    lastActiveAt: window.fs.serverTimestamp()
                });
                logTransaction(user.id.toString(), 'purchase', tokens, priceRub, name);
                window.Telegram.WebApp.showAlert(`–ö—É–ø–ª–µ–Ω–æ ${tokens} —Ç–æ–∫–µ–Ω–æ–≤!`);
                setPayModalData(null);
            };

            const handleDownload = async (e, url) => {
                if(e && e.stopPropagation) e.stopPropagation();
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('selection');
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    const ext = genType === 'image' ? 'png' : 'mp4';
                    link.download = `ai_media_${Date.now()}.${ext}`;
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => { document.body.removeChild(link); window.URL.revokeObjectURL(blobUrl); }, 500);
                    if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                } catch (e) {
                    window.Telegram.WebApp.openLink(url, { try_instant_view: false });
                }
            };

            const handleTouchStart = (item) => {
                if (item.type === 'video') return; 
                longPressTimer.current = setTimeout(() => handleDownload(null, item.url), 600); 
            };

            const handleTouchEnd = () => { if (longPressTimer.current) { clearTimeout(longPressTimer.current); longPressTimer.current = null; } };

            const deleteMedia = async (e, id) => {
                e.stopPropagation();
                if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
                const { deleteDoc, doc } = window.fs;
                await deleteDoc(doc(window.db, "users", user.id.toString(), "history", id));
            };

            const clearAllHistory = async () => {
                if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${genType === 'image' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' : '–≤–∏–¥–µ–æ'}?`)) return;
                const { deleteDoc, doc } = window.fs;
                const items = globalHistory.filter(item => item.type === genType);
                await Promise.all(items.map(item => deleteDoc(doc(window.db, "users", user.id.toString(), "history", item.id))));
                window.Telegram.WebApp.showAlert(`–û—á–∏—â–µ–Ω–æ!`);
            };

            // --- –ü–û–î–î–ï–†–ñ–ö–ê (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê) ---
            const SupportModal = () => {
                const [ticket, setTicket] = useState(null);
                const [msgs, setMsgs] = useState([]);
                const [input, setInput] = useState("");
                const [view, setView] = useState("loading"); // loading, menu, chat
                const messagesEndRef = useRef(null);

                useEffect(() => {
                    // –ò—â–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–∏–∫–µ—Ç
                    const q = window.fs.query(
                        window.fs.collection(window.db, "support_tickets"),
                        window.fs.where("userId", "==", user.id),
                        window.fs.where("status", "==", "open"),
                        window.fs.limit(1)
                    );
                    const unsub = window.fs.onSnapshot(q, (snap) => {
                        if (!snap.empty) {
                            setTicket({ id: snap.docs[0].id, ...snap.docs[0].data() });
                            setView("menu"); // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∏–∫–µ—Ç, —Å–Ω–∞—á–∞–ª–∞ –º–µ–Ω—é
                        } else {
                            setView("chat"); // –ï—Å–ª–∏ –Ω–µ—Ç, —Å—Ä–∞–∑—É —á–∞—Ç (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ)
                            setTicket(null);
                        }
                    });
                    return () => unsub();
                }, []);

                useEffect(() => {
                    if (ticket && view === "chat") {
                        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
                        const q = window.fs.query(
                            window.fs.collection(window.db, "support_tickets", ticket.id, "messages"),
                            window.fs.orderBy("createdAt", "asc")
                        );
                        return window.fs.onSnapshot(q, (snap) => {
                            setMsgs(snap.docs.map(d => d.data()));
                            setTimeout(() => messagesEndRef.current?.scrollIntoView({behavior:"smooth"}), 100);
                        });
                    } else {
                        setMsgs([]);
                    }
                }, [ticket, view]);

                const sendMsg = async () => {
                    if(!input.trim()) return;
                    let currentTicketId = ticket?.id;

                    if (!currentTicketId) {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–∏–∫–µ—Ç
                        const ref = await window.fs.addDoc(window.fs.collection(window.db, "support_tickets"), {
                            userId: user.id,
                            userName: user.first_name,
                            status: "open",
                            hasUnreadAdmin: true,
                            createdAt: window.fs.serverTimestamp(),
                            updatedAt: window.fs.serverTimestamp()
                        });
                        currentTicketId = ref.id;
                    } else {
                         // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                         window.fs.updateDoc(window.fs.doc(window.db, "support_tickets", currentTicketId), {
                            updatedAt: window.fs.serverTimestamp(),
                            hasUnreadAdmin: true
                         });
                    }

                    await window.fs.addDoc(window.fs.collection(window.db, "support_tickets", currentTicketId, "messages"), {
                        sender: "user",
                        text: input,
                        createdAt: window.fs.serverTimestamp()
                    });
                    setInput("");
                };

                const closeTicket = async () => {
                     if(ticket) {
                         await window.fs.updateDoc(window.fs.doc(window.db, "support_tickets", ticket.id), { status: "closed" });
                         setTicket(null);
                         setMsgs([]);
                         setView("chat"); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–æ–≤–æ–≥–æ
                     }
                };

                const continueChat = () => setView("chat");

                if (!supportModalOpen) return null;

                return (
                    <div className="modal-overlay" onClick={() => setSupportModalOpen(false)}>
                        <div className="modal-content w-full h-[80vh] flex flex-col p-0 overflow-hidden" onClick={e => e.stopPropagation()}>
                            <div className="bg-[#233040] p-4 flex justify-between items-center border-b border-gray-700">
                                <h3 className="font-bold text-white">üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                                <button onClick={() => setSupportModalOpen(false)}><i className="fas fa-times text-gray-400"></i></button>
                            </div>

                            {view === "menu" && (
                                <div className="flex-1 flex flex-col justify-center items-center p-6 space-y-4">
                                    <p className="text-gray-300 text-center mb-4">–£ –≤–∞—Å –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ.</p>
                                    <button onClick={continueChat} className="w-full bg-blue-600 py-3 rounded-xl font-bold text-white">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É</button>
                                    <button onClick={closeTicket} className="w-full bg-gray-700 py-3 rounded-xl text-white">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</button>
                                </div>
                            )}

                            {view === "chat" && (
                                <>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#17212b]">
                                        {msgs.length === 0 && <div className="text-gray-500 text-center mt-4">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É...</div>}
                                        {msgs.map((m, i) => (
                                            <div key={i} className={`message-bubble ${m.sender==='user'?'support-user':'support-admin'}`}>
                                                {m.text}
                                            </div>
                                        ))}
                                        <div ref={messagesEndRef}></div>
                                    </div>
                                    <div className="p-3 bg-[#233040] flex gap-2">
                                        <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 bg-gray-900 rounded-lg p-2 text-white outline-none border border-gray-600" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."/>
                                        <button onClick={sendMsg} className="bg-blue-600 w-10 h-10 rounded-lg text-white flex items-center justify-center"><i className="fas fa-paper-plane"></i></button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            const AdminSupport = ({ onClose }) => {
                const [tickets, setTickets] = useState([]);
                const [activeTicket, setActiveTicket] = useState(null);
                const [msgs, setMsgs] = useState([]);
                const [input, setInput] = useState("");
                const messagesEndRef = useRef(null);

                useEffect(() => {
                    const q = window.fs.query(window.fs.collection(window.db, "support_tickets"), window.fs.orderBy("updatedAt", "desc"));
                    return window.fs.onSnapshot(q, (snap) => {
                        setTickets(snap.docs.map(d => ({id:d.id, ...d.data()})));
                    });
                }, []);

                useEffect(() => {
                    if (activeTicket) {
                        const q = window.fs.query(
                            window.fs.collection(window.db, "support_tickets", activeTicket.id, "messages"),
                            window.fs.orderBy("createdAt", "asc")
                        );
                        // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                        window.fs.updateDoc(window.fs.doc(window.db, "support_tickets", activeTicket.id), { hasUnreadAdmin: false });
                        
                        return window.fs.onSnapshot(q, (snap) => {
                            setMsgs(snap.docs.map(d => d.data()));
                            setTimeout(() => messagesEndRef.current?.scrollIntoView({behavior:"smooth"}), 100);
                        });
                    }
                }, [activeTicket]);

                const sendReply = async () => {
                    if (!input.trim() || !activeTicket) return;
                    
                    const batch = window.fs.writeBatch(window.db);
                    const ticketRef = window.fs.doc(window.db, "support_tickets", activeTicket.id);
                    
                    batch.update(ticketRef, { updatedAt: window.fs.serverTimestamp() });
                    batch.set(window.fs.doc(window.fs.collection(window.db, "support_tickets", activeTicket.id, "messages")), {
                        sender: "admin", text: input, createdAt: window.fs.serverTimestamp()
                    });
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —é–∑–µ—Ä—É (–¢–∏–ø support, —á—Ç–æ–±—ã –±–µ–∑ –ø–æ–¥–∞—Ä–∫–∞)
                    batch.update(window.fs.doc(window.db, "users", activeTicket.userId.toString()), {
                        notification: { type: 'support', text: `–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏: ${input}` }
                    });
                    
                    await batch.commit();
                    setInput("");
                };

                return (
                    <div className="fixed inset-0 bg-[#17212b] z-50 flex flex-col page-enter">
                        <div className="h-[60px] bg-[#1c2936] flex items-center px-4 border-b border-gray-800 shrink-0 justify-between">
                            <h2 className="font-bold text-white">{activeTicket ? activeTicket.userName : "–û–±—Ä–∞—â–µ–Ω–∏—è"}</h2>
                            <button onClick={activeTicket ? ()=>setActiveTicket(null) : onClose} className="text-gray-400">
                                {activeTicket ? "–ù–∞–∑–∞–¥" : <i className="fas fa-times"></i>}
                            </button>
                        </div>

                        {!activeTicket ? (
                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {tickets.map(t => (
                                    <div key={t.id} onClick={()=>setActiveTicket(t)} className={`bg-gray-800 p-3 rounded-xl border border-gray-700 cursor-pointer ${t.hasUnreadAdmin ? 'border-l-4 border-l-red-500' : ''}`}>
                                        <div className="flex justify-between">
                                            <span className="font-bold text-white">{t.userName}</span>
                                            <span className={`text-xs ${t.status==='open'?'text-green-400':'text-gray-500'}`}>{t.status}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">{t.updatedAt?.toDate().toLocaleString()}</div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#17212b]">
                                    {msgs.map((m, i) => (
                                        <div key={i} className={`message-bubble ${m.sender==='admin'?'support-user':'support-admin'}`}>
                                            {m.text}
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef}></div>
                                </div>
                                <div className="p-3 bg-[#233040] flex gap-2">
                                    <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 bg-gray-900 rounded-lg p-2 text-white outline-none border border-gray-600" placeholder="–û—Ç–≤–µ—Ç..."/>
                                    <button onClick={sendReply} className="bg-blue-600 w-10 h-10 rounded-lg text-white flex items-center justify-center"><i className="fas fa-paper-plane"></i></button>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            // --- TABS ---

            const TabAdmin = () => {
                const [sub, setSub] = useState('set'); 
                const [lc, setLc] = useState(config);
                const [stats, setStats] = useState({ u: 0, s: 0, r: 0, l: false, online: 0 });
                const [filterPeriod, setFilterPeriod] = useState('all'); 
                const [customStart, setCustomStart] = useState('');
                const [customEnd, setCustomEnd] = useState('');
                const [searchQuery, setSearchQuery] = useState('');
                const [userResults, setUserResults] = useState([]);
                const [selectedUsers, setSelectedUsers] = useState(new Set());
                const [grantModal, setGrantModal] = useState(false);
                const [gAmount, setGAmount] = useState('');
                const [singleTarget, setSingleTarget] = useState(null);
                const [adminSupportOpen, setAdminSupportOpen] = useState(false);
                const [statusFilter, setStatusFilter] = useState('all'); // all, online, inactive

                const upd = (k, v) => setLc(p => ({...p, [k]: v}));
                const save = () => saveConfigToDb(lc);

                const updateTariff = (id, field, val) => setLc(p => ({...p, tariffs: p.tariffs.map(t => t.id===id?{...t, [field]:val}:t)}));
                const addTariff = () => setLc(p => ({...p, tariffs: [...p.tariffs, {id: Date.now(), name:'New', tokens:100, price:100}]}));
                const deleteTariff = (id) => confirm("Del?") && setLc(p => ({...p, tariffs: p.tariffs.filter(t => t.id!==id)}));

                const toggleUser = (id) => {
                    const newSet = new Set(selectedUsers);
                    if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                    setSelectedUsers(newSet);
                };

                const toggleAll = () => {
                    if (selectedUsers.size === userResults.length) setSelectedUsers(new Set());
                    else setSelectedUsers(new Set(userResults.map(u => u.id)));
                };

                const executeGrant = async () => {
                    if(!gAmount) return window.Telegram.WebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
                    const amount = Number(gAmount);
                    const targets = singleTarget ? [singleTarget] : userResults.filter(u => selectedUsers.has(u.id));
                    
                    if (targets.length === 0) return window.Telegram.WebApp.showAlert("–ù–∏–∫—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω");
                    
                    const batchSize = 400; 
                    const chunks = [];
                    for (let i=0; i < targets.length; i+=batchSize) chunks.push(targets.slice(i, i+batchSize));

                    let count = 0;
                    for (const chunk of chunks) {
                        const batch = window.fs.writeBatch(window.db);
                        chunk.forEach(u => {
                            const userRef = window.fs.doc(window.db, "users", u.id);
                            const txRef = window.fs.doc(window.fs.collection(window.db, "users", u.id, "transactions"));
                            
                            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¢–ò–ü –ü–û–î–ê–†–û–ö
                            batch.update(userRef, { 
                                balance: window.fs.increment(amount),
                                notification: { type: 'gift', text: `–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ ${amount} –±–æ–Ω—É—Å–æ–≤!` }
                            });
                            batch.set(txRef, {
                                type: 'bonus', amount: amount, amountRub: 0, description: '–ü–æ–¥–∞—Ä–æ–∫ –∞–¥–º–∏–Ω–∞',
                                createdAt: window.fs.serverTimestamp(), dateStr: new Date().toLocaleString()
                            });
                        });
                        await batch.commit();
                        count += chunk.length;
                    }
                    
                    window.Telegram.WebApp.showAlert(`–£—Å–ø–µ—à–Ω–æ: ${count} —é–∑–µ—Ä–æ–≤!`);
                    setGrantModal(false); setSingleTarget(null); setGAmount(''); setSelectedUsers(new Set());
                };

                const loadStats = async () => {
                    setStats(p => ({...p, l: true}));
                    const s = await window.fs.getDocs(window.fs.collection(window.db, "users"));
                    
                    let u=0, so=0, r=0, online=0, list=[];
                    const q = searchQuery.toLowerCase();
                    const now = new Date();
                    const tenMinsAgo = new Date(now.getTime() - 10 * 60 * 1000);
                    const fourDaysAgo = new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000);

                    s.forEach(d => { 
                        const x = d.data();
                        const regDate = new Date(x.createdAt || 0);
                        const lastActive = x.lastActiveAt ? x.lastActiveAt.toDate() : new Date(0);
                        
                        // –°—Ç–∞—Ç—É—Å—ã
                        const isOnline = lastActive > tenMinsAgo;
                        const isInactive = lastActive < fourDaysAgo;
                        if (isOnline) online++;

                        // –§–∏–ª—å—Ç—Ä –¥–∞—Ç—ã
                        let includeDate = true;
                        if (filterPeriod === 'today') includeDate = regDate.toDateString() === now.toDateString();
                        else if (filterPeriod === 'week') includeDate = regDate >= new Date(now.getTime() - 7*86400000);
                        else if (filterPeriod === 'manual' && customStart && customEnd) {
                            includeDate = regDate >= new Date(customStart) && regDate <= new Date(customEnd + 'T23:59:59');
                        }

                        if (includeDate) {
                            u++; so+=(x.balance||0); r+=(x.totalDonated||0);
                            
                            // –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞
                            const matchesSearch = !searchQuery || x.firstName?.toLowerCase().includes(q) || d.id.includes(q);
                            let matchesStatus = true;
                            if (statusFilter === 'online') matchesStatus = isOnline;
                            if (statusFilter === 'inactive') matchesStatus = isInactive;

                            if (matchesSearch && matchesStatus) {
                                list.push({id: d.id, ...x, isOnline, isInactive});
                            }
                        }
                    });
                    setStats({ u, sold: so, revenue: r, l: false, online });
                    setUserResults(list);
                };
                
                useEffect(() => { if(sub==='stat') loadStats(); }, [sub, filterPeriod, searchQuery, customStart, customEnd, statusFilter]);

                return (
                    <div className="page-enter p-5 pb-24">
                        <div className="flex justify-between mb-4">
                            <button onClick={() => setActiveTab('profile')} className="text-gray-400">–ù–∞–∑–∞–¥</button>
                            <div className="bg-gray-800 rounded p-1 flex">
                                <button onClick={() => setSub('set')} className={`px-3 py-1 rounded text-xs ${sub==='set'?'bg-blue-600':'text-gray-500'}`}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                                <button onClick={() => setSub('stat')} className={`px-3 py-1 rounded text-xs ${sub==='stat'?'bg-purple-600':'text-gray-500'}`}>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                            </div>
                        </div>
                        
                        <button onClick={()=>setAdminSupportOpen(true)} className="w-full bg-gray-800 border border-gray-700 text-white py-3 rounded-xl mb-4 flex justify-between px-4 items-center">
                            <span>üì© –°–æ–æ–±—â–µ–Ω–∏—è</span>
                            {unreadSupportCount > 0 && <span className="msg-badge">{unreadSupportCount}</span>}
                        </button>

                        {sub === 'set' ? (
                            <div className="space-y-4">
                                <button onClick={save} className="w-full bg-blue-600 py-2 rounded font-bold text-white mb-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫–æ–¥ —Ç–æ—Ç –∂–µ) */}
                                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700"><h3 className="text-blue-400 font-bold mb-2 text-xs">üîó –û—Å–Ω–æ–≤–Ω—ã–µ</h3><div className="mb-2"><label className="text-[10px] text-gray-400">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</label><input value={lc.referralBaseUrl} onChange={e => upd('referralBaseUrl', e.target.value)} className="w-full bg-gray-900 p-2 rounded text-xs text-white border border-gray-600"/></div><div><label className="text-[10px] text-gray-400">Token BotFather</label><input value={lc.botToken} onChange={e => upd('botToken', e.target.value)} className="w-full bg-gray-900 p-2 rounded text-xs text-white border border-gray-600"/></div></div>
                                {/* ... –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ... */}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {/* –§–∏–ª—å—Ç—Ä—ã –¥–∞—Ç—ã */}
                                <div className="flex gap-2 mb-4 overflow-x-auto pb-2"><button onClick={() => setFilterPeriod('all')} className={`px-3 py-1 rounded-full text-xs border ${filterPeriod==='all'?'bg-white text-black':'border-gray-600 text-gray-400'}`}>–í—Å–µ</button><button onClick={() => setFilterPeriod('today')} className={`px-3 py-1 rounded-full text-xs border ${filterPeriod==='today'?'bg-white text-black':'border-gray-600 text-gray-400'}`}>–°–µ–≥–æ–¥–Ω—è</button><button onClick={() => setFilterPeriod('week')} className={`px-3 py-1 rounded-full text-xs border ${filterPeriod==='week'?'bg-white text-black':'border-gray-600 text-gray-400'}`}>–ù–µ–¥–µ–ª—è</button><button onClick={() => setFilterPeriod('manual')} className={`px-3 py-1 rounded-full text-xs border ${filterPeriod==='manual'?'bg-white text-black':'border-gray-600 text-gray-400'}`}>–ü–µ—Ä–∏–æ–¥</button></div>
                                {filterPeriod === 'manual' && (<div className="bg-gray-800 p-3 rounded-xl border border-gray-700 mb-4 grid grid-cols-2 gap-2"><input type="date" value={customStart} onChange={e => setCustomStart(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/><input type="date" value={customEnd} onChange={e => setCustomEnd(e.target.value)} className="w-full bg-gray-900 text-white text-xs p-2 rounded border border-gray-600"/></div>)}

                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–Æ–∑–µ—Ä–æ–≤</div><div className="text-xl font-bold text-white">{stats.u}</div></div>
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–û–Ω–ª–∞–π–Ω</div><div className="text-xl font-bold text-green-400">{stats.online}</div></div>
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–¢–æ–∫–µ–Ω–æ–≤</div><div className="text-xl font-bold text-blue-400">{stats.sold}</div></div>
                                    <div className="bg-gray-800 p-3 rounded-xl"><div className="text-gray-400 text-xs">–í—ã—Ä—É—á–∫–∞</div><div className="text-xl font-bold text-yellow-400">{stats.revenue} ‚ÇΩ</div></div>
                                </div>
                                
                                <div className="mt-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setStatusFilter('all')} className={`text-[10px] px-2 py-1 rounded ${statusFilter==='all'?'bg-gray-600':'bg-gray-800'}`}>–í—Å–µ</button>
                                            <button onClick={()=>setStatusFilter('online')} className={`text-[10px] px-2 py-1 rounded ${statusFilter==='online'?'bg-green-900 text-green-200':'bg-gray-800 text-green-500'}`}>Online</button>
                                            <button onClick={()=>setStatusFilter('inactive')} className={`text-[10px] px-2 py-1 rounded ${statusFilter==='inactive'?'bg-yellow-900 text-yellow-200':'bg-gray-800 text-yellow-500'}`}>Inactive</button>
                                        </div>
                                        {selectedUsers.size > 0 && <button onClick={() => setGrantModal(true)} className="text-xs bg-pink-600 px-3 py-1 rounded text-white font-bold">–ü–æ–¥–∞—Ä–∏—Ç—å ({selectedUsers.size})</button>}
                                    </div>
                                    <div className="flex gap-2 mb-2">
                                        <input placeholder="–ü–æ–∏—Å–∫..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="flex-1 bg-gray-900 rounded p-2 text-white border border-gray-700 text-xs"/>
                                        <button onClick={toggleAll} className="bg-gray-700 px-3 rounded text-xs text-white">–í—Å–µ</button>
                                    </div>
                                    <div className="bg-gray-900 rounded-lg overflow-y-auto max-h-80 border border-gray-700">
                                        {userResults.map(u => (
                                            <div key={u.id} className="p-2 border-b border-gray-800 flex items-center gap-2 hover:bg-gray-800">
                                                <div className={`custom-checkbox ${selectedUsers.has(u.id)?'checked':''}`} onClick={() => toggleUser(u.id)}><i className="fas fa-check"></i></div>
                                                <div className="flex-1 min-w-0" onClick={() => {setSingleTarget(u); setGrantModal(true);}}>
                                                    <div className="flex items-center">
                                                        <span className={`status-dot ${u.isOnline?'status-green':(u.isInactive?'status-yellow':'status-gray')}`}></span>
                                                        <div className="text-white text-xs font-bold truncate">{u.firstName}</div>
                                                    </div>
                                                    <div className="text-gray-500 text-[10px] truncate">{u.id}</div>
                                                </div>
                                                <span className="text-yellow-500 text-xs">{u.balance}</span>
                                                <button onClick={() => setHistoryModalUser(u)} className="text-blue-400 p-2"><i className="fas fa-book"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {grantModal && (
                            <div className="modal-overlay" onClick={() => {setGrantModal(false); setSingleTarget(null);}}>
                                <div className="modal-content" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-lg font-bold text-white mb-2">{singleTarget ? `–ë–æ–Ω—É—Å –¥–ª—è ${singleTarget.firstName}` : `–†–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è ${selectedUsers.size} —á–µ–ª.`}</h3>
                                    <input type="number" placeholder="–°—É–º–º–∞ —Ç–æ–∫–µ–Ω–æ–≤" value={gAmount} onChange={e => setGAmount(e.target.value)} className="w-full bg-gray-900 rounded p-2 text-white border border-gray-600 mb-4"/>
                                    <button onClick={executeGrant} className="w-full bg-green-600 py-2 rounded text-white font-bold mb-2">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                                    <button onClick={() => {setGrantModal(false); setSingleTarget(null);}} className="w-full text-gray-400">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        )}
                        {adminSupportOpen && <AdminSupport onClose={()=>setAdminSupportOpen(false)} />}
                    </div>
                );
            };

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (FullScreenModal, PayModal, ShareModal) —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –±—ã–ª–∏
            const FullScreenModal = () => {if (!fullscreenItem) return null; return (<div className="modal-overlay" onClick={() => setFullscreenItem(null)}><div className="close-fs-btn" onClick={() => setFullscreenItem(null)}>&times;</div>{fullscreenItem.type === 'image' ? <img src={fullscreenItem.url} className="fullscreen-media" onClick={e => e.stopPropagation()} /> : <video src={fullscreenItem.url} controls autoPlay className="fullscreen-media" onClick={e => e.stopPropagation()} />}</div>);};
            const PayModal = () => {if (!payModalData) return null; return (<div className="modal-overlay" onClick={() => setPayModalData(null)}><div className="modal-content" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-white mb-4">–û–ø–ª–∞—Ç–∞</h3><div className="text-blue-400 font-bold mb-4">{payModalData.name}</div><div className="text-2xl font-bold text-green-400 mb-4">{payModalData.price} ‚ÇΩ</div><button onClick={() => processPurchase(payModalData.tokens, payModalData.price, payModalData.name)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3">–û–ø–ª–∞—Ç–∏—Ç—å (–¢–µ—Å—Ç)</button><button onClick={() => setPayModalData(null)} className="w-full text-gray-500 py-2">–û—Ç–º–µ–Ω–∞</button></div></div>);};
            const ShareModal = () => {if (!shareModalItem) return null; return (<div className="modal-overlay" onClick={() => setShareModalItem(null)}><div className="modal-content"><h3 className="text-white mb-4">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3><button onClick={()=>{navigator.clipboard.writeText(shareModalItem.url); setShareModalItem(null)}} className="w-full bg-blue-600 text-white py-3 rounded mb-2">–ö–æ–ø–∏—è —Å—Å—ã–ª–∫–∏</button><button onClick={() => setShareModalItem(null)} className="text-gray-400">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>);};

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-16 transition-all ${activeTab === id ? 'text-blue-500 scale-110' : 'text-gray-500'}`}>
                    <i className={`fas ${icon} text-xl mb-1`}></i><span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            if (isLoading) return <div className="flex h-screen items-center justify-center text-blue-500"><i className="fas fa-circle-notch fa-spin text-2xl"></i></div>;
            
            return (
                <div className="min-h-screen bg-[#17212b]">
                    {activeTab === 'generate' && <TabGenerate />}
                    {activeTab === 'chat' && <TabChat />}
                    {activeTab === 'profile' && <TabProfile />}
                    {activeTab === 'admin' && <TabAdmin />}
                    
                    {!(activeTab === 'chat' && document.querySelector('.chat-input-area')) && (
                        <div className="fixed bottom-0 left-0 right-0 bg-[#1c2936] border-t border-gray-800 pb-safe pt-2 px-6 flex justify-around z-50 h-[70px]">
                            <NavItem id="generate" icon="fa-wand-magic-sparkles" label="–ò–º–∏–¥–∂" />
                            <NavItem id="chat" icon="fa-comments" label="–ß–∞—Ç" />
                            <NavItem id="profile" icon="fa-user-circle" label="–ü—Ä–æ—Ñ–∏–ª—å" />
                        </div>
                    )}

                    {payModalData && <PayModal />}
                    {shareModalItem && <ShareModal />}
                    {fullscreenItem && <FullScreenModal />}
                    {historyModalUser && <HistoryModal />}
                    {supportModalOpen && <SupportModal />}
                    
                    {notification && (
                         <div className="modal-overlay" onClick={() => setNotification(null)}>
                            <div className="modal-content text-center">
                                {notification.type === 'gift' ? (
                                    <>
                                        <div className="text-4xl mb-2">üéÅ</div>
                                        <h3 className="text-xl font-bold text-white mb-2">–ü–æ–¥–∞—Ä–æ–∫!</h3>
                                    </>
                                ) : (
                                    <h3 className="text-xl font-bold text-white mb-2">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                                )}
                                <p className="text-gray-300 mb-4">{notification.text}</p>
                                <button onClick={() => setNotification(null)} className="w-full bg-blue-600 text-white py-2 rounded-xl font-bold">–û–ö</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


